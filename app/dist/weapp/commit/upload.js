'use strict';var _exports;function init(){const a=require('fs'),b=require('./pack.js'),c=require('./build.js'),d=require('path'),f=require('../../common/request/request.js'),g=require('../../config/dirConfig.js'),h=require('../../stores/projectStores.js'),i=require('../../config/urlConfig.js'),j=require('rmdir'),k=require('zlib'),l=require('../../common/log/log.js');_exports={};var m=g.Weappdest;_exports.uploadForTest=(n,o,p)=>{let q=h.getProjectConfig(n),r;try{r=q.Setting.MaxCodeSize}catch(u){r=1}let s=1024*r,t=!o.isBuildForUpload;c(n,{noCompile:!0},(u,v)=>{if(u)return void p(u.toString());let w=d.join(m,`${+new Date}.wx`);b(v,w,(x,y)=>{j(v,(F,G,H)=>{});let z=a.lstatSync(w),A=parseInt(z.size/1024);if(A>s)return a.unlink(w,()=>{}),void p(`代码包大小为 ${A} kb，超出限制 ${A-s} kb，请删除文件后重试`);let B,C=!0;if(t){o.isNewFeature?(B=`${i.testSourceNewFeatureURL}?appid=${n.appid}`,C=!1):B=`${i.testSourceURL}?appid=${n.appid}&gzip=1`;let{page:F,query:G}=o;if(F){let H=encodeURIComponent(`${F}?${G}`);B=`${B}&path=${H}`}}else{let F=encodeURIComponent(o.desc),G=encodeURIComponent(o.version),H=encodeURIComponent(o.uuid);B=`${i.commitSourceURL}?appid=${n.appid}&user-version=${G}&user-desc=${F}&uuid=${H}&gzip=1`}let D=a.readFileSync(y);l.info(`upload.js upload file ${y} length ${D.length}`);let E;C&&(E=k.gzipSync(D),l.info(`upload.js upload file ${y} after gzip length ${E.length}`)),f({url:B,method:'post',body:C?E:D,needToken:1},(F,G,H)=>{p(F,G,H,{MAX_APP_LENGTH:s}),a.unlink(w,()=>{})})})})},_exports.upload=(n,o,p)=>{o.isBuildForUpload=!0,_exports.uploadForTest(n,o,p)}}init(),module.exports=_exports;