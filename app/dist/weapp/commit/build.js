"use strict";var _exports;function init(){function a(z){return 0===Buffer.compare(new Buffer(z.toString(),"utf8"),z)}const b="darwin"===process.platform,c=global.appConfig.isDev,d=require("fs"),f=require("path"),g=require("../utils/tools.js"),h=require("glob"),j=require("async"),k=require("../../config/dirConfig.js"),l=k.WeappVendor,m=require("mkdir-p"),n=require("./initAppConfig.js"),o=require("./initAppServiceJs.js");require("child_process").spawn;const p=require("../../common/log/log.js"),q=require("babel-core"),r=require("autoprefixer"),s=require("postcss"),t=require("uglify-js"),u=c?f.join(__dirname,"../vendor/"):l;b?f.join(u,"wcc"):f.join(u,"wcc.exe");const v=["iOS >= 8","Chrome >= 37"];let w=k.Weappdest;const x={".js":!0,".json":!0,".wxml":!0,".wcss":!0},y=g.whiteFileExtName;_exports=(z,A,B)=>{z.projectpath;let C=z.es6,D=z.minified,E=z.postcss,F=f.join(w,`${+new Date}`);m.sync(F);let G={};G.appconfig=H=>{n(z,A,(I,J)=>{H(I,J)})},G.appservicejs=H=>{o(z,A,(I,J)=>{H(I,J)})},j.parallel(G,(H,I)=>{return H?void B(H.toString()):void h("./**",{nodir:!0,cwd:z.projectpath,ignore:["./node_modules/**/*"]},(J,K)=>{if(J)p.error(`build.js error while glob files ${J.toString()}`),B(J.toString(),F);else{for(let L=0;L<K.length;L++){let M=K[L],N=f.extname(M);if(!y[N])p.info(`build.js find file not in whiteList ${M}`);else{let O=f.join(F,M),P=f.dirname(O);m.sync(P);let Q;try{Q=d.readFileSync(f.join(z.projectpath,M))}catch(R){return void B(R.toString(),F)}if(x[N]&&!a(Q))return void B(`${M} - 不是 UTF8 编码，请检查后重试`);if(".js"===N){let R=Q.toString();if(!C&&!D)d.writeFileSync(O,R);else{let S=R;if(C)try{let T=q.transform(R,{presets:["es2015"],babelrc:!1});S=T.code}catch(T){return void B(`${M} - ${T}`)}if(D){let T=t.minify(`(function(){\n ${S} \n})()`,{fromString:!0});S=T.code}d.writeFileSync(O,S)}}else if(E&&".wxss"===N){let R=Q.toString();try{let S=s([r({browsers:v,remove:!1})]).process(R).css;d.writeFileSync(O,S,"utf8")}catch(S){return void B(S)}}else{let R=Q;d.writeFileSync(O,R)}}}B(null,F)}})})}}init(),module.exports=_exports;