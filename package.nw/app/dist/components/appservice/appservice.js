'use strict';var _exports;function init(){const a=require('../../lib/react.js');require('../../lib/react-dom.js');const b=require('../../cssStr/cssStr.js'),c=require('../../stores/webviewStores.js'),d=require('../../stores/windowStores.js'),f=require('../../actions/webviewActions.js'),g=require('../../stores/projectStores.js'),h=require('../../actions/projectActions.js'),j=require('../../weapp/utils/tools.js'),k=require('./../../common/log/log.js'),l=require('../../common/assdk/asSdk.js'),m=require('../../debugger/debugger.js'),n=require('../../config/dirConfig.js'),o=require('../../actions/windowActions.js'),q=require('./console/showconsole.js'),r=require('../../config/config.js'),s=require('./port/port.js'),u=100000,v=1000000,w='about:blank';var x;let y={};const z=function(B,C){o.showConfirm({content:B,callback:C})},A=a.createClass({displayName:'DevTools',getInitialState:function(){let B=c.getNetworkType();return{isWxml:!1,networkType:B}},addContentScripts:function(B){B.addContentScripts([{name:'contentScripts',matches:['<all_urls>'],js:{files:['app/dist/contentscript/contentScript.js']},run_at:'document_start'}])},_initport:function(B){let C=B.name;if(`webview${u}`===C)this.port.init(B),this.port.postMessage('contentscript',{},'SHAKE_HANDS');else if(`webview${v}`===C){if(this.devtoolsview.src===w)return;this.devtoolsPort.init(B),this.devtoolsPort=B,this.devtoolsPort.postMessage('contentscript',{},'SHAKE_HANDS')}},_externalPort:function(B){let C=B.name;'storage'===C?(this.storagePort.init(B),this.storagePort.postMessage('',{},'SHAKE_HANDS')):'appdata'===C?(this.appdataPort.init(B),this.appdataPort.postMessage('',{},'SHAKE_HANDS')):'wxml'===C&&(this.wxmlPort.init(B),this.wxmlPort.postMessage('',{},'SHAKE_HANDS'))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},storageMessage:function(B){if('GET_APP_DATA'===B.command){let C={storage:j.getProjectStorage(this.props.project)};this.storagePort.postMessage('',C,'tabui-setAsData')}},wxmlMessage:function(B){let{command:C,ext:D,data:E}=B;if('GET_CURRENT_DEBUGGEE'===C){let F=c.getCurrentWebviewID(),G=this.debuggeeMap[F];if(!G)return void k.error(`appservice.js error do not find ${F} debuggee`);this.wxmlPort.postMessage('',{res:{debuggee:G},ext:D,args:E},'GET_CURRENT_DEBUGGEE')}else'SEND_COMMAND'===C?('DOM.setInspectMode'===E.method&&'none'===E.commandParams.mode&&this.setState({isWxml:!1}),m.sendCommand(E.debuggee,E.method,E.commandParams,F=>{this.wxmlPort.postMessage('',{res:F,ext:D,args:E},'GET_DEVTOOLS_RES')})):'OPEN_FILE'===C&&o.openProjectFile(E)},appdataMessage:function(B){let C=B.command;'GET_APP_DATA'===C?this.port.postMessage('appservice',{},'GET_APP_DATA'):'WRITE_APP_DATA'===C&&this.port.postMessage('appservice',B.data,'WRITE_APP_DATA')},onMessage:function(B){if('COMMAND_FROM_ASJS'===B.command){let J=B.sdkName;if('__open-tools-log'===J)return void nw.Shell.openItem(n.WeappLog);if('__open-tools-vendor'===J)return void nw.Shell.openItem(n.WeappVendor);if('APP_SERVICE_COMPLETE'===J)return void c.emit('APPSERVICE_INIT');if('send_app_data'===J)return void this.appdataPort.postMessage('',B,'SEND_APP_DATA');if('publish'===J)return void f.asPublish(B);if('__show-new-feature-check'===J)return void o.toggleNewFeatureCheckShowStatus(!0);if('__hhdmbadmb'===J){const K=require('path'),L=require('fs');let M=K.join(__dirname,'../../../html/ext.html');return L.existsSync(M)?void nw.Window.open('app/html/ext.html',{show:!0,width:1219,height:1219},N=>{}):void 0}'__show-sys-info'===J&&chrome.processes.getProcessInfo([],!0,K=>{let L=0,M=[];for(let O in K){let P=K[O];P.privateMemory&&(L+=P.privateMemory),M.push({osProcessId:P.osProcessId,type:P.type,privateMemory:P.privateMemory/1024/1024})}L=L/1024/1024;let N=g.getRestartInfo();this.port.postMessage('contentscript',{memory:L,restartInfo:N,info:M},'SHOW_SYS_INFO')}),l.exec(B,(K,L)=>{setTimeout(()=>{this.port.postMessage('appservice',K,'GET_ASSDK_RES',B)},0)})}},initExternal:function(){chrome.runtime.onConnectExternal.addListener(this._externalPort)},newWindow:function(B){B.addEventListener('newwindow',function(C){let D=C.targetUrl;D&&('https://developers.google.com/web/tools/chrome-devtools/'===D&&(D='https://mp.weixin.qq.com/debug/wxadoc/dev/index.html'),nw.Window.open(D,{width:799,height:799}))})},_initAppservice:function(){function B(){function I(){D.removeEventListener('loadcommit',I),D.showDevTools(!0,F)}F.removeEventListener('loadcommit',B),D.addEventListener('loadcommit',I),D.src=`http://${H.hash}.appservice.open.weixin.qq.com/appservice`}let C=this.refs.container,D=this.appserviceWebview=document.createElement('webview');D.style.cssText='height:0.01px;width:0.01px';let E=D.getUserAgent();D.setUserAgentOverride(`${E} appservice webview/${u}`),C.appendChild(D),this.addContentScripts(D);let F=this.devtoolsview=document.createElement('webview');F.className=`devtools-content`;let G=`${F.getUserAgent()} asviewdevtools webview/${v} chromeRuntimeID/${chrome.runtime.id}`;F.setUserAgentOverride(G),F.setAttribute('partition','persist:trusted'),C.appendChild(F),this.addContentScripts(F),this.newWindow(F);let H=this.props.project;F.addEventListener('loadcommit',B),F.src=w,this.initRuntime(),this.initExternal(),this.onHeadersReceived(),this.onBeforeSendHeaders(),this.onErrorOccurred(),this.onSyncMessage(),this.onSyncDevtoolsMessage()},_postMsgToAS:function(B){this.port.postMessage('appservice',B,'MSG_FROM_WEBVIEW')},_upASData:function(B,C){this.storagePort.postMessage('',{storage:C},'tabui-setAsData')},_restart:function(){let B=this.props.project;this.appserviceWebview.src=`http://${B.hash}.appservice.open.weixin.qq.com/appservice`},_startDebuggee:function(B,C){let D=C.webview,E=C.webviewOffset;new Date,m.start(D,{webviewOffset:E},F=>{this.debuggeeMap[B]=F,this.wxmlPort.postMessage('',{debuggee:F},'CHANGE_DEBUGGEE'),f.touchSetSuc(B)},(F,G,H={})=>{if('DOM.inspectNodeRequested'===G&&this.setState({isWxml:!1}),'DOM.inlineStyleInvalidated'!==G&&'DOM.characterDataModified'!==G){if('DOM.nodeHighlightRequested'===G&&'DOM.nodeHighlightRequested'===y.method&&H.nodeId===y.nodeId)return;y='DOM.nodeHighlightRequested'===G?{method:G,nodeId:H.nodeId}:{};let J=c.getOffset();this.wxmlPort.postMessage('',{debuggee:F,method:G,params:H,offset:J},'ON_EVENT')}},(F,G)=>{for(let H in this.wxmlPort.postMessage('',{debuggee:F},'ON_DETACH'),this.debuggeeMap)this.debuggeeMap[H].targetId===F.targetId&&delete this.debuggeeMap[H]})},_changeWebview:function(B){let C=this.debuggeeMap[B];C&&this.wxmlPort.postMessage('',{debuggee:C},'CHANGE_DEBUGGEE')},_setWebviewInfo:function(B){for(let C in this.debuggeeMap)m.sendCommand(this.debuggeeMap[C],'Emulation.setDeviceMetricsOverride',{width:parseInt(B.width),height:parseInt(B.height),deviceScaleFactor:B.dpr,mobile:!0,fitWindow:!1})},_getWeappError:function(B,C,D){this.port.postMessage('appservice',{fileName:j.getFileNameFromUrl(C),errStr:D},'WINDOW_GET_WEBAPP_ERROR')},inspector:function(){return this.wxmlPort.hasInit?void(this.setState({isWxml:!0}),this.wxmlPort.postMessage('',{},'SET_INSPECT_MODE')):void o.showTipsMsg({msg:'\u8BF7\u5148\u5207\u6362\u81F3 Wxml Pannel',type:'error'})},onSyncDevtoolsMessage:function(){let B=this.devtoolsview;B.addEventListener('dialog',C=>{let D=C.messageType||'',E=C.messageText;if('prompt'===D){let F=/^____sdk____/.test(E);if(F){let G=JSON.parse(E.replace(/^____sdk____/,'')),H=G.command;if('GET_GEO_SETTING'===H){let I=c.getGeoSetting();C.dialog.ok(JSON.stringify(I))}else'SET_GEO_SETTING'===H&&c.setGeoSetting(G.geoSetting)}}})},onSyncMessage:function(){let B=this.appserviceWebview;B.addEventListener('dialog',C=>{let D=C.messageType||'',E=C.messageText;if('prompt'===D){let F=/^____sdk____/.test(E);if(F){let G=JSON.parse(E.replace(/^____sdk____/,'')),H=G.command;if('COMMAND_FROM_ASJS'===H){let I=G.sdkName;l.exec(G,(J,K)=>{C.dialog.ok(JSON.stringify({to:'appservice',msg:J,command:'GET_ASSDK_RES',ext:G})),('setStorageSync'===I||'clearStorageSync'===I)&&f.upASData(K.appid,K.storage)})}}}else if('confirm'===D){C.preventDefault();let F=C.dialog;z(E,G=>{G?F.ok():F.cancel()})}})},onBeforeSendHeaders:function(){let B=this.appserviceWebview,C=B.request,D=this.props.project;C.onBeforeSendHeaders.addListener(E=>{let F=E.url;if('main_frame'===E.type&&F.match(/\?load$/))return clearTimeout(x),x=setTimeout(()=>{h.restart(this.props.project)},500),{cancel:!0};if(0!=F.indexOf(`http://${D.hash}.appservice.open.weixin.qq.com`)&&'none'==this.state.networkType)return this.appserviceWebview.executeScript({code:`console.group("${new Date} 无网络状态模拟")
                console.debug(\`已开启无网络状态模拟，网络请求已被阻止；在工具栏切换网络状态，可恢复网络请求。\`)
                console.groupEnd()`}),{cancel:!0};let G=E.requestHeaders||[],H=G.findIndex(J=>{return'cookie'===J.name.toLowerCase()});G.splice(H,1);for(var I=0;I<G.length;++I)'_Cookie'===G[I].name&&(G[I].name='Cookie'),'Referer'===G[I].name&&(G[I].value=`https://servicewechat.com/${D.appid}/devtools/page-frame.html`);return{requestHeaders:E.requestHeaders}},{urls:['<all_urls>']},['blocking','requestHeaders'])},onHeadersReceived:function(){let B=this.appserviceWebview,C=B.request;C.onHeadersReceived.addListener(D=>{let E=D.type;if('script'===E){let F=D.responseHeaders||[],G=F.find(H=>{return H.name===r.ES6_ERROR});G&&this._showWeappError(r.ES6_ERROR,G.value)}},{urls:['<all_urls>']},['blocking','responseHeaders'])},onErrorOccurred:function(){let B=this.appserviceWebview,C=B.request;C.onErrorOccurred.addListener(D=>{let{type:E}=D;'main_frame'===E&&0===D.error.indexOf('net::')&&'net::ERR_BLOCKED_BY_CLIENT'!==D.error&&this.port.postMessage('contentscript',D,'ERR_CONNECTION_RESET')},{urls:['<all_urls>']})},_showWeappError:function(B,C){if('edit'===this.props.propshow&&/ERROR\:?$/.test(B)&&B!==r.WEBVIEW_ERROR&&setTimeout(()=>{o.showTipsMsg({msg:'\u7F16\u8BD1\u51FA\u73B0\u9519\u8BEF\uFF0C\u8BF7\u53BB\u63A7\u5236\u53F0\u67E5\u770B\u8BE6\u7EC6\u4FE1\u606F',type:'error'})},17),0===B.indexOf('JSON'))return void q(this.appserviceWebview,B,C);if(/\?load$/.test(this.appserviceWebview.src))return void q(this.appserviceWebview,B,C);let D=0,E=setInterval(()=>{let F=this.appserviceWebview.src||'';/\?load$/.test(F)?(q(this.appserviceWebview,B,C),clearInterval(E)):(D++,20==D&&clearInterval(E))},500)},_onSimulatorNetworkChange:function(B){this.setState({networkType:B})},componentDidMount:function(){this.port=new s({onMessage:this.onMessage}),this.devtoolsPort=new s,this.storagePort=new s({onMessage:this.storageMessage}),this.wxmlPort=new s({onMessage:this.wxmlMessage}),this.appdataPort=new s({onMessage:this.appdataMessage}),this.debuggeeMap={},this._initAppservice(),c.on('POST_MSG_TOAS',this._postMsgToAS),c.on('UP_AS_DATA',this._upASData),g.on('RESTART_PROJECT',this._restart),d.on('START_WEBVIEW_DEBUGGEE',this._startDebuggee),d.on('WINDOW_CHANGE_WEBVIEW_ID',this._changeWebview),d.on('SET_WEBVIEW_INFO',this._setWebviewInfo),d.on('WINDOW_GET_WEBAPP_ERROR',this._getWeappError),d.on('WINDOW_SHOW_WEBAPP_ERROR',this._showWeappError),c.on('SIMULATOR_NETWORK_CHANGE',this._onSimulatorNetworkChange)},componentWillUnmount:function(){this.devtoolsview.remove(),this.appserviceWebview.remove(),c.removeListener('POST_MSG_TOAS',this._postMsgToAS),c.removeListener('UP_AS_DATA',this._upASData),g.removeListener('RESTART_PROJECT',this._restart),d.removeListener('START_WEBVIEW_DEBUGGEE',this._startDebuggee),d.removeListener('WINDOW_CHANGE_WEBVIEW_ID',this._changeWebview),d.removeListener('SET_WEBVIEW_INFO',this._setWebviewInfo),d.removeListener('WINDOW_GET_WEBAPP_ERROR',this._getWeappError),d.removeListener('WINDOW_SHOW_WEBAPP_ERROR',this._showWeappError),c.removeListener('SIMULATOR_NETWORK_CHANGE',this._onSimulatorNetworkChange),chrome.runtime.onConnectExternal.removeListener(this._externalPort),chrome.runtime.onConnect.removeListener(this._initport)},render:function(){let B='appservice'===this.props.show?{height:'100%'}:b.webviewDisplayNone;'edit'===this.props.propshow&&(B=b.webviewDisplayNone);let C='debug'===this.props.propshow?{}:b.displayNone,D=this.state.isWxml?'devtools-inspector devtools-inspector-active':'devtools-inspector';return a.createElement('div',{style:B,ref:'container',className:'devtools'},a.createElement('div',{className:'devtools-inspector-bg',style:C}),a.createElement('div',{style:C,onClick:this.inspector,className:D}))}});_exports=A}init(),module.exports=_exports;