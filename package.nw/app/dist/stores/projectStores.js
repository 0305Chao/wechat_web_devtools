'use strict';var _exports;function init(){function a(H){let J,K,L,I=0;if(0===H.length)return I;for(J=0,L=H.length;J<L;J++)K=H.charCodeAt(J),I=(I<<5)-I+K,I|=0;return 0<I?I:0-I}function b(){let H=JSON.stringify(y);localStorage.setItem('projectLists',H),g.writeFile(x,H)}function c(H,I){if(I){let R=H.projectpath,S=f.join(__dirname,'../weapp/newquick/');try{let T=j.sync(`./**/**`,{cwd:S});T.forEach(U=>{let V=f.join(S,U),W=f.join(R,U),X=g.lstatSync(V);if(X.isDirectory())k.sync(W);else{let Y=g.readFileSync(V);g.writeFileSync(W,Y)}})}catch(T){h.error(`projectStores.js initProject error ${T.toString()}`)}}}function d(H,I=()=>{}){const J=require('../actions/windowActions.js');J.showConfirm({content:H,type:'alert',callback:I})}const f=require('path'),g=require('fs'),h=require('../common/log/log.js'),j=require('glob'),k=require('mkdir-p'),l=require('../common/request/request.js'),m=require('../config/urlConfig.js'),n=require('../config/errcodeConfig.js');require('../weapp/commit/unpack.js');const o=require('../config/dirConfig.js'),p=require('../utils/file.js'),q=require('events').EventEmitter,r='last-select-project',{SELECT_URL_TYPE:s,SELECT_UNKNOW_TYPE:t}=require('../config/config.js');var u=0,v=+new Date;let w=o.WeappProjectInfo;if(!w){const H=f.join(nw.App.getDataPath(),'..');w=f.join(H,'WeappProject')}const x=f.join(w,'projectinfo.json');var y=JSON.parse(localStorage.getItem('projectLists'))||[];g.writeFile(x,localStorage.getItem('projectLists')||'[]');var z={},A=null,B={},C=!1,D=parseInt(localStorage.getItem(r))||t;const E={Network:{RequestDomain:[],WsRequestDomain:[],UploadDomain:[],DownloadDomain:[]},Setting:{MaxLocalstorageSize:10,MaxCodeSize:5,MaxWebviewDepth:5,MaxBackgroundLifespan:300,MaxRequestConcurrent:5,MaxUploadConcurrent:1,MaxDownloadConcurrent:5,MaxFileStorageSize:100}};y.forEach(H=>{H.hash=a(H.projectid),H.es6===void 0&&(H.es6=!0),H.watcher===void 0&&(H.watcher=!0),H.editWebview===void 0&&(H.editWebview=!0),H.postcss===void 0&&(H.postcss=!0),H.urlCheck===void 0&&(H.urlCheck=!0),H.newFeature===void 0&&(H.newFeature={show:!1,check:!1,time:Date.now()}),global.appConfig.isBeta&&!1===H.newFeature.check&&(H.newFeature.check=!0),H.initPath===void 0&&(H.initPath={enable:!1,page:'',query:''}),H.uploadPath===void 0&&(H.uploadPath={enable:!1,page:'',query:''})});const F=(H,I)=>{if(!C){C=!0;let W=m.getWeappAttrURL,X=`${W}?appid=${H.appid}&_r=${Math.random()}`;h.info(`projectStores.js begin get projectAttr ${X}`),l({url:X,body:JSON.stringify({appid_list:[H.appid]}),method:'post',needToken:1},(Y,Z,$)=>{if(C=!1,Y)return h.error(`projectStores.js end requestProjectAttr network error: ${JSON.stringify(Y)}`),void I(Y);h.info(`projectStores.js end requestProjectAttr ${$}`);let _;try{_=JSON.parse($)}catch(ca){return h.error(`projectStores.js end requestProjectAttr parse body error: ${$} ${JSON.stringify(Y)}`),void I(`系统错误 ${$}`)}let aa=_.baseresponse,ba=aa?parseInt(aa.errcode):0;if(0===ba){let ca=_.attr_list[0],da=ca.jsapi_list,ea={};if(da&&0<da.length){for(let fa=0;fa<da.length;fa++){let ga=da[fa];ea[ga.name]=ga}delete ca.jsapi_list,ca.permission=ea}I(null,ca)}else ba===n.DEV_App_Not_Band&&(d('\u5F53\u524D\u5F00\u53D1\u8005\u672A\u7ED1\u5B9A\u6B64 appid \uFF0C\u8BF7\u5230 mp \u540E\u53F0\u64CD\u4F5C\u540E\u91CD\u8BD5',()=>{nw.Shell.openExternal('https://mp.weixin.qq.com/')}),h.error(`projectStores.js setProjectConfig error ${ba}`)),I(`系统错误 ${$}`)})}},G=Object.assign({},q.prototype,{getLastSelect:function(){if(D===s||D===t)return parseInt(D);let H=this.getProjectByHash(D);if(H){let I=`projectattr${H.hash}`,J;try{J=JSON.parse(localStorage.getItem(I))}catch(L){return t}let K=H.isTourist;if(J||K)return G.setProjectConfig(H,()=>{}),H}return t},setProjectType:function(H){D=H,localStorage.setItem(r,H)},getCurrentProject:function(){return A},getCurrentProjectConfig:function(){return this.getProjectConfig(A)},setProjectPostCss:function(H,I){let J=this.getProjectByHash(H);J.postcss=I,b()},setProjectEs6:function(H,I){let J=this.getProjectByHash(H);J.es6=I,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',J)},setProjectUrlCheck:function(H,I){let J=this.getProjectByHash(H);J.urlCheck=I,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',J)},setProjectMinified:function(H,I){let J=this.getProjectByHash(H);J.minified=I,b()},setProjectEditWebview:function(H,I){let J=this.getProjectByHash(H);J.editWebview=I,b(),this.emit('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',J,I)},setProjectNewFeature:function(H,I){let J=this.getProjectByHash(H);J.newFeature=I,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',J)},setProjectWatcher:function(H,I){let J=this.getProjectByHash(H);J.watcher=I,b()},setProjectInitPath:function(H,I){let J=this.getProjectByHash(H);J.initPath=I,b()},setProjectUploadPath:function(H,I){let J=this.getProjectByHash(H);J.uploadPath=Object.assign({},J.uploadPath,I),b()},getProjectByHash:function(H){return H=parseInt(H),y.find(I=>{return I.hash===H})},getProjectByID:function(H){return y.find(I=>{return I.projectid===H})},getProjectList:function(){return y},addVerifyProject:function(H,I){},add:function(H,I){H.hash=a(H.projectid),H.es6=!0,H.watcher=!0,H.editWebview=!0,H.newFeature={time:Date.now(),show:!1,check:!1},H.initPath={enable:!1},H.uploadPath={enable:!1},y.unshift(H),c(H,I),b(),h.info(`projectStores.js add ${JSON.stringify(H)}`),this.emit('ADD_PROJECT',y)},del:function(H){let I=y.findIndex(J=>{return J.projectid===H});if(-1<I){let J=y[I];delete localStorage[`projectattr${J.hash}`],y.splice(I,1),b(),p.cleanProjectFile(J,!0),h.info(`projectStores.js del ${H}`),this.emit('DEL_PROJECT',y)}},close:function(){this.emit('CLOSE_PROJECT')},restart:function(H){u++,this.emit('RESTART_PROJECT',H)},getRestartInfo:function(){return{projectRestartNum:u,projectBeginTime:v}},getProjectConfig:function(H){return z[H.hash]},setProjectConfig:function(H,I){if(A=H,H.isTourist){let L=Object.assign({},E);return L.appid=H.appid,z[H.hash]=L,void I()}let K,J=`projectattr${H.hash}`;try{K=JSON.parse(localStorage.getItem(J))}catch(L){h.error('projectStores.js setProjectConfig parse localStorage projectAttr error')}K&&K.permission&&(z[H.hash]=K,I()),F(H,(L,M)=>{L?'NOT_LOGIN'===L.type?d('\u767B\u5F55\u6001\u5931\u6548\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55'):!K&&d(L):(z[H.hash]=M,localStorage.getItem(J)!=JSON.stringify(M)&&(localStorage.setItem(J,JSON.stringify(M)),this.emit('PROJECT_STORES_CONFIG_CHANGE',H)),!K&&I()),this.emit('PROJECT_CONFIG_REFRESHED')})},getSdkUserAuthStorage:function(H){if(B[H.hash])return B[H.hash];let I=`projectuserauth_${H.hash}`,J={};try{J=JSON.parse(localStorage.getItem(I))||{}}catch(K){localStorage.setItem(I,'{}'),h.error('projectStores.js getSdkUserAuthStorage parse localStorage Sdk error')}return B[H.hash]=J||{},B[H.hash]},setUserAuthPemissionStorage:function(H,I){B[H.hash]&&(B[H.hash]=I||{});let J=`projectuserauth_${H.hash}`;localStorage.setItem(J,JSON.stringify(I||{}))}});_exports=G}init(),module.exports=_exports;