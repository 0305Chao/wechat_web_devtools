'use strict';var _exports;function init(){const a=require('../../stores/projectStores.js');require('../../stores/webviewStores.js');const b=require('../../actions/windowActions.js'),c=require('../../common/request/request.js'),{jsLoginURL:d,jsRefreshSessionURL:f,jsOperateWXDATAURL:g,jsAuthorizeURL:h,jsAuthorizeConfirmURL:j}=require('../../config/urlConfig.js');_exports={login:function(l,m){let n=a.getProjectByHash(l.apphash),o=n.appid;c({url:`${d}?appid=${o}`,method:'post',body:JSON.stringify({scope:['snsapi_base']}),needToken:1},(p,q,r)=>{let s={},t='';p||200!==q.statusCode?t=p.toString():(r=JSON.parse(r),r.baseresponse&&(0==r.baseresponse.errcode?s={errMsg:'login:ok',code:r.code}:t=r.baseresponse.errmsg)),s.errMsg||(s.errMsg=`login:fail ${t}`),m(s)})},refreshSession:function(l,m){let n=a.getProjectByHash(l.apphash),o=n.appid;c({url:`${f}?appid=${o}`,method:'post',needToken:1},(p,q,r)=>{let s={},t='';p||200!==q.statusCode?t=p.toString():(r=JSON.parse(r),r.baseresponse&&(0==r.baseresponse.errcode?s={errMsg:'refreshSession:ok',expireIn:r.session_expire_in,err_code:r.baseresponse.errcode}:t=r.baseresponse.errmsg)),s.errMsg||(s.errMsg=`refreshSession:fail ${t}`),m(s)})},operateWXData:function(l,m){let n='',o=l.args,p=o.data.api_name,q=a.getCurrentProject(),r=a.getSdkUserAuthStorage(q);q&&(n=q.appid);let s=function(t){'function'==typeof m&&(m(t),m=void 0)};c({url:`${g}?appid=${n}`,method:'post',body:JSON.stringify({data:JSON.stringify(o.data||{})}),needToken:1},(t,u,v)=>{let w={},x='';if(!t&&200===u.statusCode&&(v=JSON.parse(v),v.baseresponse))if(0==v.baseresponse.errcode)try{w.data=JSON.parse(v.data),w.errMsg='operateWXData:ok'}catch(y){w.errMsg='operateWXData:fail'}else{if(-12000==v.baseresponse.errcode){let y=(z,A)=>{w.errMsg=z?'operateWXData:ok':'operateWXData:fail auth deny';let B=A[0];z?(r[`operateWXData_${p}`]=1,a.setUserAuthPemissionStorage(q,r)):s(w);let C={data:JSON.stringify(o.data||{}),grant_scope:B.scope,opt:z?1:2};c({url:`${g}?appid=${n}`,method:'post',body:JSON.stringify(C),needToken:1},(D,E,F)=>{let G={};if(!D&&200===E.statusCode&&(F=JSON.parse(F),F.baseresponse&&0===F.baseresponse.errcode))try{G.data=JSON.parse(F.data),G.errMsg='operateWXData:ok'}catch(H){G.errMsg='operateWXData:fail'}G.errMsg||(G.errMsg='operateWXData:fail'),s(G)})};if(r[`operateWXData_${p}`]){let z=v.scope;z.checked=!0,y(!0,[z])}else b.showAuthorizeConfirm({appicon_url:`${v.appicon_url}`,appname:v.appname,scope_list:[v.scope],callback:y});return}x=v.baseresponse.errmsg}w.errMsg||(w.errMsg='operateWXData:fail '+x),m(w)})},authorize:function(l,m){let n='',o=l.args,p=a.getCurrentProject();p&&(n=p.appid);let q=function(r){'function'==typeof m&&(m(r),m=void 0)};c({url:`${h}?appid=${n}`,method:'post',body:JSON.stringify({scope:o.scope||[]}),needToken:1},(r,s,t)=>{let u={},v='';if(!r&&200===s.statusCode&&(t=JSON.parse(t),t.baseresponse))if(u.body=t,0==t.baseresponse.errcode)u.errMsg='authorize:ok';else{if(-12000==t.baseresponse.errcode)return void b.showAuthorizeConfirm({appicon_url:`${t.appicon_url}`,appname:t.appname,scope_list:t.scope_list,callback:(w,x)=>{u.errMsg=w?'authorize:ok':'authorize:fail auth deny',w||q(u);let y=[];for(let z=0;z<x.length;++z){let A=x[z];!A.checked||y.push(A.scope)}c({url:`${j}?appid=${n}`,method:'post',body:JSON.stringify({scope:y,opt:w?1:2}),needToken:1},(z,A,B)=>{let C={};z||200!==A.statusCode||(B=JSON.parse(B),B.baseresponse&&0===B.baseresponse.errcode&&(C.errMsg='authorize:ok')),C.errMsg||(C.errMsg='authorize:fail'),q(C)})}});v=t.baseresponse.errmsg}u.errMsg||(u.errMsg='authorize:fail '+v),m(u)})}}}init(),module.exports=_exports;