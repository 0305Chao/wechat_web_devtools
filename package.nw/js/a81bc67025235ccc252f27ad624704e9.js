'use strict';!function(require,directRequire){function a(){let a=g.getCurrent(),b='tourist'==a.appid,c=a.setting.urlCheck,d=!0;return b?d=!1:!c&&(d=!1),d}const b=require('fs'),c=require('path'),d=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),e=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),f=require('./233d77ecf0781f44985f684f70e316d0.js'),g=require('./3bfffbe88b3d923921f851c0697974fe.js'),h=require('./c6f15ef7a40988103528a2ff766b2425.js'),i=require('./a1dd553cc059d528bb0ef56afed53968.js');let j=0,k=0,l={},m=1,n={},o=1;module.exports={downloadFile:async function(e,i){let j=i.args;const l=d.getState(),m=l.toolbar.network.list[l.toolbar.network.current];let n=g.getCurrent();if('none'==m)return{errMsg:`${i.api}:fail network is down`};const o=g.getCurrentConfig(),p=1024*(1024*o.setting.DownloadFileSizeLimit),q=l.simulator.appConfig||{},r=o.setting.MaxDownloadConcurrent;return k>=r?{errMsg:`${i.api}:fail exceed max download connection count ${r}`}:new Promise((d)=>{let e=!1;const l=(a)=>{e||(k--,d(a),e=!0)};try{k++;let d=0,e=200,m=h.createNewLocalId()+c.extname(j.url.split('?')[0]),o=h.getRealPath(m),r=j.header||{};r.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;let s={method:'get',url:j.url,encoding:null,headers:r,timeout:q.networkTimeout&&q.networkTimeout.downloadFile||6e4,followRedirect:function(a){let b=!1;(n.urlCheck||n.isTourist)&&(b=!0);let c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let c=a.caseless.get('location'),d=g.getCurrentDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?s.agentOptions={secureProtocol:'TLSv1_2_method'}:s.tunnel=!1;let t=f(s);t.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)l({errMsg:`${i.api}:ok`,statusCode:e});else{let b=parseInt(a.headers['content-length']);b>p&&(t.abort(),l({errMsg:`${i.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?l({errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}):a&&'ETIMEDOUT'===a.code?l({errMsg:`${i.api}:fail timeout`}):l({errMsg:`${i.api}:fail ${a}`})}).on('data',(a)=>{d+=a.length,d>p&&(t.abort(),l({errMsg:`${i.api}:fail exceed max file size`}))}).on('end',()=>{l({errMsg:`${i.api}:ok`,tempFilePath:m,statusCode:e})}).pipe(b.createWriteStream(o))}catch(a){l({errMsg:`${i.api}:fail ${a}`})}})},uploadFile:async function(c,i){let e=i.args;const k=g.getCurrentConfig(),l=k.setting.MaxUploadConcurrent,m=d.getState(),n=m.toolbar.network.list[m.toolbar.network.current];if('none'==n)return{errMsg:`${i.api}:fail network is down`};if(j>=l)return{errMsg:`${i.api}:fail exceed max upload connection count ${l}`};let o=e.filePath,p=h.getRealPath(o);if(!b.existsSync(p))return{errMsg:`${i.api}:fail file not found`};const q=m.simulator.appConfig||{};return new Promise((c)=>{let d=!1;const h=(a)=>{d||(j--,d=!0,c(a))};try{j++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:q.networkTimeout&&q.networkTimeout.uploadFile||6e4};a()?c.agentOptions={secureProtocol:'TLSv1_2_method'}:c.tunnel=!1,c.formData[e.name]=b.createReadStream(p),c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}:'ETIMEDOUT'===a.code?{errMsg:`${i.api}:fail timeout`}:{errMsg:`${i.api}:fail ${a}`}:{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c},h(d)})}catch(a){h({errMsg:`${i.api}:fail ${a}`})}})},createUploadTask:async function(c,k){let e=k.args,n=g.getCurrentConfig();const o=n.setting.MaxUploadConcurrent,p=d.getState(),q=p.toolbar.network.list[p.toolbar.network.current];if('none'==q)return{errMsg:`${k.api}:fail network is down`};if(j>=o)return{errMsg:`${k.api}:fail exceed max upload connection count ${o}`};let r=e.filePath,s=h.getRealPath(r);if(!b.existsSync(s))return{errMsg:`${k.api}:fail file not found`};const t=p.simulator.appConfig||{};try{j++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:t.networkTimeout&&t.networkTimeout.uploadFile||6e4};c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`,a()&&(c.agentOptions={secureProtocol:'TLSv1_2_method'});let d=b.createReadStream(s);c.formData[e.name]=d;let h=m++,n=b.statSync(s),o=0;d.on('data',function(a){o+=a.length,i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:h,state:'progressUpdate',progress:Math.floor(100*(o/n.size)),totalBytesSent:o,totalBytesExpectedToSend:n.size}})});const p=(a)=>{l[h]&&(i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:Object.assign({uploadTaskId:h},a)}),j--,delete l[h])};let q=f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{state:'success',statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{state:'fail',errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}:'ETIMEDOUT'===a.code?{statSync:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`}:{state:'success',statusCode:b.statusCode,data:c},p(d)});return q.on('abort',()=>{setTimeout(()=>{p({state:'fail',errMsg:'abort'})},0)}),l[h]={id:h,request:q},{errMsg:`${k.api}:ok`,uploadTaskId:h}}catch(a){return j--,{errMsg:`${k.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){let c=b.args,d=c.uploadTaskId,e=c.operationType,f=l[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(j,l){let m=l.args;const p=d.getState(),q=p.toolbar.network.list[p.toolbar.network.current];let r=g.getCurrent();if('none'==q)return{errMsg:`${l.api}:fail network is down`};const s=g.getCurrentConfig(),t=s.setting.MaxDownloadConcurrent;if(k>=t)return{errMsg:`${l.api}:fail exceed max download connection count ${t}`};const u=1024*(1024*s.setting.DownloadFileSizeLimit);let v=m.header||{};v.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;try{k++;let d=0,q=200,s=h.createNewLocalId()+c.extname(m.url.split('?')[0]),t=h.getRealPath(s),w=p.simulator.appConfig||{},x={method:'get',url:m.url,encoding:null,headers:v,timeout:w.networkTimeout&&w.networkTimeout.downloadFile||6e4,followRedirect:function(a){let b=!1;(r.urlCheck||r.isTourist)&&(b=!0);let c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let c=a.caseless.get('location'),d=g.getCurrentDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?x.agentOptions={secureProtocol:'TLSv1_2_method'}:x.tunnel=!1;let y=o++;j({type:e.ASSDK_CALLBACK,res:{errMsg:`${l.api}:ok`,downloadTaskId:y},callbackID:l.callbackID});let z=f(x);n[y]={downloadTaskId:y,request:z};let A=u;const B=(a)=>{n[y]&&(delete n[y],k--,i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:Object.assign({downloadTaskId:y},a)}))},C=(a)=>{i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:y,state:'progressUpdate',progress:a}})};z.on('response',(a)=>{if(q=a.statusCode,200!=q&&206!=q)B({state:'success',statusCode:q});else{let b=parseInt(a.headers['content-length']);b>u?(z.abort(),B({state:'fail',errMsg:'downloadFile:fail exceed max file size'})):A=b}}).on('error',function(a){a&&'EPROTO'===a.code?B({state:fail,errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):a&&'ETIMEDOUT'===a.code?B({state:'fail',errMsg:`timeout`}):B({state:'fail',errMsg:`${a}`})}).on('data',(a)=>{d+=a.length,d>u?(B({state:'fail',errMsg:'exceed max file size'}),z.abort()):C(d/A)}).on('abort',()=>{setTimeout(()=>{B({state:'fail',errMsg:'abort'})},0)}).on('end',()=>{B({state:'success',tempFilePath:s,statusCode:q})}).pipe(b.createWriteStream(t))}catch(a){return{errMsg:`${l.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){let c=b.args,d=c.downloadTaskId,e=c.operationType,f=n[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}}}}(require('lazyload'),require);