'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){async function a(a,b,c,d,e={}){const f=e.onProgressUpdate||G,g=async(c)=>{const d=(await m(a,c,{noWarnings:!0}))||'',e=x(j.join(b,decodeURI(c)),d,{inlineSources:!0}),f='object'==typeof e?JSON.stringify(e):'';return f?d.replace(/^\/\/[#|@] sourceMappingURL=[\s]*(\S*)[\s]*$/m,`\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,${new Buffer(f).toString('base64')}`):d},k='weapp:///',n=j.join(b,'app.json'),o=i.readFileSync(n,'utf8'),p=await v(a);if(!p.pages)throw new Error('no pages defined.');let q=p.pages.map((a)=>{return a+'.js'}),z=[];const A=await u.getProjectFiles(a),B=await A.getAllJSONFiles();for(let f,g=0,h=B.length;g<h;g++)if(f=B[g].replace(/\.json$/,''),j.normalize(f)!=j.normalize('app'))try{let b=await r(a,f);b&&!0===b.component&&z.push(f)}catch(a){console.error(a);continue}const C=[],D=[];if(p.subPackages){const b=[];for(const d of p.subPackages){if(!d||!d.root||!d.pages)continue;d.root=d.root.replace(/\\/g,'/'),d.root=d.root.startsWith('/')?d.root.slice(1):d.root,d.root=d.root.endsWith('/')?d.root:d.root+'/';const c=d.pages.map((a)=>j.posix.join(d.root,a));b.push(...c.map((a)=>a+'.js'));const e=z.filter((a)=>a.startsWith(d.root)),f=await t(a,{page:d.root,cut:!0});C.push(f.code);for(const b of[...e,...c]){const c=b,d=c.replace(/\"/g,'\\"').replace(/`/g,'\\`');let e={};try{e=await y(a,c)}catch(a){e={}}D.push(`
          __wxAppCode__["${d}.wxml"] = ${f.name}("./${d}.wxml")
          __wxAppCode__["${d}.json"] = ${JSON.stringify(e)}
        `)}}q=[...q,...b]}0<z.length&&(z=z.map((a)=>a+'.js')),q=q.filter((a)=>{return 0>z.findIndex((b)=>b===a)});const E=l.sync('**/*.js',{cwd:b,ignore:[...['node_modules/**/*','**/node_modules/**','**/.git/**','.git/**/*','**/.svn/**','.svn/**/*','.DS_Store','**/.DS_Store'],'app.js',...z,...q],nocase:!0,dot:!0,nodir:!0});let F;try{F=await g('app.js')}catch(a){throw new Error('getjs app.js fail,'+a)}let H=[';'+F,';require("app.js");',`//# sourceURL=${k}app.js\n`].join('\n'),I=j.join(c,'app.js');h.sync(j.dirname(I)),i.writeFileSync(I,H,'utf-8'),H=o,I=j.join(c,'app.json'),h.sync(j.dirname(I)),i.writeFileSync(I,H,'utf-8'),f('preparefile','\u51C6\u5907 Components \u6587\u4EF6');for(const f of z){const d=j.join(b,f);if(!i.existsSync(d))throw new Error(f+' does not exists');if(i.lstatSync(d).isDirectory())throw new Error(f+' is a directory');const e=f.replace(/\.js$/i,''),l=(await r(a,e))||{};try{F=await g(encodeURI(f))}catch(a){throw new Error('getjs '+d+' fail,'+a)}if(p.plugins&&l.usingComponents)for(const a in l.usingComponents)l.usingComponents[a]=l.usingComponents[a].replace(/^plugin:\/\/([^\/]*)\/(.*)/,(a,b,c,d,e)=>{const f=p.plugins[b];return f?`plugin://${f.provider}/${c}`:e});H=[`;var __wxAppCode__ = __wxAppCode__ || {}; __wxAppCode__["${e}.json"] = ${JSON.stringify(l)}; var __wxRoute = "${e.replace(/"/g,'\\"')}"; var __wxRouteBegin = true; var __wxAppCurrentFile__ ="${f.replace(/"/g,'\\"')}"; `+F,`;require("${f.replace(/"/g,'\\"')}");`,`//# sourceURL=${k}${f}\n`].join('\n'),I=j.join(c,f),h.sync(j.dirname(I)),i.writeFileSync(I,H,'utf-8')}f('preparefile','\u51C6\u5907 Page \u6587\u4EF6');for(const f of q){const d=j.join(b,f);if(!i.existsSync(d))throw new Error(f+' does not exists');if(i.lstatSync(d).isDirectory())throw new Error(f+' is a directory');const e=f.replace(/\.js$/i,''),l=(await r(a,e))||{};try{F=await g(encodeURI(f))}catch(a){throw new Error('getjs '+d+' fail,'+a)}if(p.plugins&&l.usingComponents)for(const a in l.usingComponents)l.usingComponents[a]=l.usingComponents[a].replace(/^plugin:\/\/([^\/]*)\/(.*)/,(a,b,c,d,e)=>{const f=p.plugins[b];return f?`plugin://${f.provider}/${c}`:e});H=[`;var __wxAppCode__ = __wxAppCode__ || {}; __wxAppCode__["${e}.json"] = ${JSON.stringify(l)}; var __wxRoute = "${e.replace(/"/g,'\\"')}"; var __wxRouteBegin = true; var __wxAppCurrentFile__ ="${f.replace(/"/g,'\\"')}"; `+F,`;require("${f.replace(/"/g,'\\"')}");`,`//# sourceURL=${k}${f}\n`].join('\n'),I=j.join(c,f),h.sync(j.dirname(I)),i.writeFileSync(I,H,'utf-8')}f('preparefile','\u51C6\u5907 JS \u6587\u4EF6');for(const f of E){const a=j.join(b,f);if(!i.existsSync(a))throw new Error(f+' does not exists');if(i.lstatSync(a).isDirectory())throw new Error(f+' is a directory');try{F=await g(encodeURI(f))}catch(b){throw new Error('getjs '+a+' fail,'+b)}H=[';var __wxAppData = __wxAppData || {}; var __wxRoute; var __wxRouteBegin; var __wxAppCode__ = __wxAppCode__ || {}; var global = global || {}; var __wxAppCurrentFile__; var Component = Component || function() {}; var Behavior = Behavior || function() {}; '+F,`//# sourceURL=${k}${f}\n`].join('\n'),I=j.join(c,f),h.sync(j.dirname(I)),i.writeFileSync(I,H,'utf-8')}let J;try{J=await s(a)}catch(a){throw new Error('getWxAppCode fail,'+a)}I=j.join(d,'wxappcode.js'),i.writeFileSync(I,`;var __wxAppCode__ = __wxAppCode__ || {}; ${[...J,...D].join(';\n;')};\n//# sourceURL=[__wxAppCode__]`,'utf-8');let K;try{K=await t(a,{app:!0,cut:!0})}catch(a){throw new Error('transWXMLToJS fail,'+a)}const L=K.code;I=j.join(d,'wxmlxcjs.js'),i.writeFileSync(I,`${[L,...C].join(';\n;')}\n//# sourceURL=[__wxmlXCJS__]`,'utf-8');let M;try{if(p.plugins){let b=[];for(const c in p.plugins){const{provider:d,version:e}=p.plugins[c],f=await w.getServiceCode(a,{pluginId:d,version:e});b.push(`;${f};\n`)}M=b.join('\n')}}catch(a){throw new Error('getWxPluginCode fail,'+a)}return I=j.join(d,'wxplugincode.js'),i.writeFileSync(I,`${M}\n//# sourceURL=[__wxPluginCode__]`,'utf-8'),['app.json',...E,'app.js',...z,...q]}function b(){if(!0===z)return void(E=!0);if(z){try{z.destroy()}catch(a){}z=null}}const{RemoteTempDir:c,RemoteDir:d,RemoteDataDir:e}=require('./a148d3a11fd5268109e21fb40c9d527b.js'),{commonError:f,randomId:g}=require('./46d7303eb986fa402d60bf5e929aa077.js'),h=require('mkdir-p'),j=require('path'),i=require('fs'),k=require('rmdir'),l=require('glob'),m=require('./87c0ac209c25d8bb448550638bb17663.js'),{RemoteDebug:n}=require('./6c6f4dde020ed24929c4c4367c42d34d.js'),o=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),p=o.getState.bind(o),q=o.subscribe.bind(o),r=require('./d260ebf687a29f24aed49f66b233ab7d.js'),s=require('./334bc661e13bd1837a230f0835d0a1ee.js'),t=require('./3e4c71c2a2cc438e1b3afc3fb10bd4b6.js'),u=require('./6b5520e429c60abf5d2f924c0fa05fd0.js'),v=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),w=require('./b6d8659542036f6a35f417e0693e56db.js'),x=require('./cdbf7243dc99f8461acbb1d57af1d8ae.js'),y=require('./e2bb00408a93b45ef5e6ad32f05e850c.js');let z=!1,A=[],B=[],C=null,D=null,E=!1,F={mode:'server'};const G=function(){};let H=null;const I={getStatus(){if(!z||!0===z)return null;const a=F.mode;return{messager:'server'===a?{compressionSavedBytes:z.messager.compressionSavedBytes,status:z.messager.status,inSpeed:z.messager.inSpeed,outSpeed:z.messager.outSpeed,outDebugMessageSpeed:z.messager.outDebugMessageSpeed,inDebugMessageSpeed:z.messager.inDebugMessageSpeed,outDebugMessageCount:z.messager.outDebugMessageCount,inDebugMessageCount:z.messager.inDebugMessageCount,inCount:z.messager.inCount,outCount:z.messager.outCount,inBytesCount:z.messager.inBytesCount,outBytesCount:z.messager.outBytesCount,sendQueueLength:z.messager.sendQueue.length,cachedDebugMessagesCount:z.messager.debugMessagesToSend.length,unconfirmedMessagesCount:(()=>{const a=z.messager.cachedDebugMessageSendGroups;let b=0;for(const c of a)b+=((c&&!c.confirmed&&c.sendDebugMessageRequest||{}).debug_message||[]).length;return b})()}:{status:z.messager.status,inDebugMessageSpeed:z.messager.inDebugMessageSpeed,outDebugMessageSpeed:z.messager.outDebugMessageSpeed,outDebugMessageCount:z.messager.outDebugMessageCount,inDebugMessageCount:z.messager.inDebugMessageCount,inBytesCount:z.messager.inBytesCount,outBytesCount:z.messager.outBytesCount,cachedDebugMessagesCount:z.messager.debugMessagesToSend.length,unconfirmedMessagesCount:z.messager.unconfirmedMessagesCount},_debugger:{status:z.debuggerStatus},dirs:{dir:z.dir,tempDir:z.tempDir},client:{deviceInfo:z.deviceInfo,networkType:z.clientNetworkType,networkSpeed:z.clientNetworkSpeed,networkInterval:z.clientNetworkInterval},currentSyncSdkName:(()=>{let a=z.currentSyncSdkName;if(!a&&z.syncCallIds){const b=Object.keys(z.syncCallIds);0<b.length&&(a=z.syncCallIds[b[0]])}return a})()}},subscribeChange(a){A.push(a)},subscribeEvent(a){B.push(a)},changeDebuggerStatus(a){z&&!0!==z&&z.changeDebuggerStatus(a)},onAskForRetry(a){C=a},onOpenEditorFile(a){D=a},endDebug(){z&&!0!==z&&z.destroy()},getInstance(){return z&&!0!==z?z:null}};module.exports={init:async function(i,l={},m={}){return new Promise(async(o,r)=>{const s=m.onProgressUpdate||G;if(s('remotedebug','\u521D\u59CB\u5316\u8C03\u8BD5\u73AF\u5883'),z){console.warn('already an instance');const a=p();return a&&a.window&&a.window.remoteDebugWindow&&!a.window.remoteDebugWindow.show?(console.warn('shall be destroyed'),b(),r('\u8BF7\u91CD\u65B0\u5C1D\u8BD5\u4E00\u6B21\u3002')):r(f('remote debug instance already exists'))}const t=g(),u=j.join(d,i.appid||t,t),v=j.join(c,i.appid||t,t),w=j.join(e,i.appid||t),x=()=>{try{k(u),k(v)}catch(a){}};try{z=!0;const{projectpath:c,miniprogramRoot:d}=i;h.sync(u),h.sync(v),h.sync(w);const e=j.join(c,d||'');s('remotedebug','\u51C6\u5907\u6587\u4EF6');const f=await a(i,e,u,v,{onProgressUpdate:s});if(E){E=!1;throw'Aborted. Please retry'}z=new n({files:f,dir:u,tempDir:v,dataDir:w,initialRoomInfo:_extends({},l),config:_extends({},m),mode:m.remoteDebugLocal?m.remoteDebugLocal:'server',clientProxyPort:m.clientProxyPort});const g=m.onStatusUpdate||G,k=m.onEvent||G;z.onAskForRetry((a)=>{return new Promise(async(b)=>{C?b((await C(a))):b(!1)})}),z.onOpenEditorFile((...a)=>{D&&D(...a)}),z.onAskForChoosingAndroidDevice((a)=>{return new Promise(async(b)=>{console.log(a),setTimeout(()=>{b(0)},1e3)})}),z.onAskForAndroidAuthorize((a)=>{return new Promise(async(b)=>{console.log(a),setTimeout(()=>{b(!0)},1e3)})});let t;z.once('initsuccess',(a)=>{return E?(E=!1,z.destroy(),r('abort')):void(t=!0,o(_extends({},a)),'function'==typeof H&&(H(),H=null),H=q(()=>{const a=p();a&&a.window&&a.window.remoteDebugWindow&&a.window.remoteDebugWindow.show&&(console.log('subscribed remote window shown'),'function'==typeof H&&(H(),H=q(()=>{const a=p();a&&a.window&&a.window.remoteDebugWindow&&!a.window.remoteDebugWindow.show&&(console.warn('shall automatically be destroyed'),'function'==typeof H&&(H(),H=null),b())})))}))});const y=(a)=>{E=!1,A=[],B=[],C=null,D=null,x(),'function'==typeof H&&(H(),H=null),void 0===t&&(t=!1,r(a)),z&&z.destroy(),z=null};z.once('initfail',y),z.once('destroy',(a)=>{E=!1,z&&z.removeAllListeners(),z=null;for(const b of A)b(!0);A=[],B=[],C=null,D=null,x(),'function'==typeof H&&(H(),H=null),void 0===t&&(t=!1,r(a))});let I;z.on('statuschange',()=>{I||(I=setTimeout(()=>{I=void 0;for(const a of A)a();const a=z&&z.messager&&z.messager.status;g(a,4<a)},400))}),z.on('event',(a)=>{for(const b of B)b(a);a&&k(a)}),F={mode:m.remoteDebugLocal?m.remoteDebugLocal:'server'};try{s('remotedebug','\u521D\u59CB\u5316\u8C03\u8BD5\u5B9E\u4F8B'),await z.init(),s('remotedebug','\u7B49\u5F85\u8FDB\u7A0B')}catch(a){throw y(a),a}}catch(a){x(),z=null,r(f(a))}})},onUrlRequest:function(a){if(!z||!0===z)return void console.warn('no active instance');const b=a.replace(/^\/*remotedebug\/+/i,'').toLowerCase();switch(!0){case b.startsWith('registersyncpid/'):{const a=b.replace(/^\/*registersyncpid\/+/g,'');let[c,d]=a.split('/');if(c=parseInt(c,10),d=parseInt(d,10),isNaN(c)||isNaN(d))return void console.warn('invalid pid or sdkid');z.registerSyncPid(c,d);break}default:console.warn('invalid request href');}},destroy:b,model:I}}(require('lazyload'),require);