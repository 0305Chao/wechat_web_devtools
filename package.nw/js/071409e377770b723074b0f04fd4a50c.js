'use strict';!function(require,directRequire){const a=require('path'),b=require('react'),c=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),d=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),e=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),f=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),g=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),h=require('./dca9191eced65b3831d60c02d8d487c2.js'),i=require('./d62fc37d7aa6416d5dcc240ba94175cd.js'),j=require('./9a24eb4fb7a49d4dd24531943fc3c899.js'),k=require('./3bfffbe88b3d923921f851c0697974fe.js'),l=require('./e3681b47a6ce46a8998b8cdff40bdb12.js'),m=require('./a78e6d6a87de1708226375ca4c320d76.js'),n=require('./92320c1386e6db6a6f2556736a9bc280.js'),o=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),{enterForeground:p}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),q=require('querystring'),r=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),s=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),t=require('./common/locales/index.js'),u=require('./72653d4b93cdd7443296229431a7aa9a.js'),v=require('./9beb6be9c4f08fd7406b0e6f964234ea.js');let w;chrome.webRequest.onBeforeSendHeaders.addListener((a)=>{let{type:b,url:c}=a;if('websocket'===b&&0!==c.indexOf(`ws://localhost:${global.messageCenterPort}`)){let b=a.requestHeaders||[],c=k.getProjectAppID();if(b.push({name:'Referer',value:`https://servicewechat.com/${c}/devtools/page-frame.html`}),w){for(let a in w)b.push({name:a,value:w[a]});w=void 0}return{requestHeaders:b}}},{urls:['<all_urls>']},['blocking','requestHeaders']);const{connect:x}=require('react-redux');class y extends b.Component{constructor(a){super(a),this.syncDialogMap={},this.restartTimer=null,this.loaded=!1,this._onMessage=this.onMessage.bind(this)}componentDidMount(){l.register(this._onMessage),this.initWebview(),this.container.addEventListener('mouseleave',()=>{j.send({command:'SET_TOUCH_MODE',data:!1})}),this.container.addEventListener('mouseenter',()=>{j.send({command:'SET_TOUCH_MODE',data:!0})})}componentWillReceiveProps(a){if((a.compileCommand!==this.props.compileCommand||a.device!=this.props.device)&&(clearTimeout(this.restartTimer),this.restartTimer=setTimeout(()=>{this.reStart()})),a.assdkCallbackInfo!=this.props.assdkCallbackInfo){let{callbackID:b,res:c}=a.assdkCallbackInfo;this.syncDialogMap[b]?(this.syncDialogMap[b].ok(JSON.stringify(c)),delete this.syncDialogMap[b]):l.invokeCallback(b,c)}(a.height!=this.props.height||a.width!=this.props.width)&&setTimeout(()=>{this.setWebviewOffset()}),a.captureScreen!=this.props.captureScreen&&setTimeout(()=>{this.captureScreen()})}componentWillUnmount(){this.webview&&this.webview.detach(),e.simulatorReset(),l.unRegister(this._onMessage)}onMessage(a){let{command:b,data:c}=a;'APPSERVICE_INVOKE'==b?setTimeout(()=>{this.props.assdkActions.exec(c)}):'SYSTEM'==b&&this.onSystemCommand(c.api,c.data)}captureScreen(){this.webview.captureVisibleRegion({format:'png'},(a)=>{let b=Buffer.from(a.replace('data:image/png;base64,',''),'base64'),c=o.copyFileDataToTemp(this.props.project,b,'.png'),{webviewID:d,callbackID:e}=this.props.captureScreen;this.props.simulatorActions.assdkCallback({callbackID:e,res:{errMsg:'captureScreen:ok',tempFilePath:c}})})}tryCaptureScreenForBackground(){this._captureTryCount||(this._captureTryCount=0),this._captureTryCount++;try{this.webview.captureVisibleRegion({format:'png'},async(a)=>{try{const b=await v({taskName:'isSameColorImage',config:{type:'dataURI',format:'png'},dataStr:a,maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw new Error(b.error);if(b.same){if(5<this._captureTryCount)return;setTimeout(this.tryCaptureScreenForBackground.bind(this),2e3)}else this.props.projectActions.updateProjectCover({image:a})}catch(a){u.error('process capture screen failure with err: '+a.toString(),a.stack)}})}catch(a){u.error('gamewebview chrome capture screen failure with err: '+a.toString())}}onSystemCommand(a,b){switch(a){case'checkProxy':{try{let a=nw.App.getProxyForURL(b);l.send({command:'SYSTEM_CALLBACK',data:{api:'checkProxy',data:[{url:b,proxy:a}]}})}catch(a){}break}case'showDecryptedInfo':{l.send({command:'SYSTEM_CALLBACK',data:{api:'showDecryptedInfo',data:this.props.decryptedInfo}});break}case'showSystemInfo':{chrome.processes.getProcessInfo([],!0,(a)=>{let b=0,c=[];for(let d in a){let e=a[d];e.privateMemory&&(b+=e.privateMemory);let{tasks:f,type:g}=e;'extension'===g&&(g='',f.forEach((a)=>{a.tabId||(title=a.title.replace(/.*open\.weixin\.qq\.com\//g,'').replace(/\?.*/,''),g+=`${title};`)}),g=g.replace(/网页视图：/g,'')),g=g.replace('\u7F51\u9875',''),c.push({type:g,osProcessId:e.osProcessId,privateMemory:(e.privateMemory/1024/1024).toFixed(2)})}b=b/1024/1024,l.send({command:'SYSTEM_CALLBACK',data:{api:'showSystemInfo',data:{restartInfo:{restartTimes:this.props.restartTimes,beginTime:moment(global.beginTime).calendar()},memory:b,info:c}}})});break}case'openToolsLog':{nw.Shell.openItem(n.WeappLog);break}case'openVendor':{nw.Shell.openItem(n.WeappVendor);break}case'syncMessage':{syncMessage.sync();break}case'qcloudup':{(async(a={})=>{let b=await qcloud.operate(this.props.project,a);l.send({command:'SYSTEM_CALLBACK',data:{api:'qcloudup',data:b}})})(b);break}case'build':{this.props.simulatorActions.compile({origin:s.COMPILE_ORIGIN.CONSOLE});break}case'preview':{this.props.toolbarActions.togglePreviewCode();break}case'upload':{this.props.infoActions.setUploadInfo({show:!0});break}default:}}setWebviewOffset(){let a=this.props,b=a.height/a.deviceScale,c=a.width/a.deviceScale;this.webview&&this.webview.setAttribute('style',`position:absolute;height:${b}px;width:${c}px`)}setUserAgentOverride(){let a=this.props.ua.replace('{{webviewID}}',this.props.id);a+=` gameservice port/${global.messageCenterPort}`,this.webview.setUserAgentOverride(a)}initWebview(){let a=this.props,b=m.get('gamesimulator',{width:a.width,height:a.height,dpr:a.dpr},{isGame:!0});this.webview&&this.webview.detach(),this.webview=b,this.setWebviewOffset(),b.attach(this.container),this.setUserAgentOverride(),this.initEvent(b),this.loaded=!1;const c=()=>{this.props.setGame({webview:b}),b.src=`http://127.0.0.1:${global.proxyPort}/game/gamePage.html`,r.initWebview(b._webview),this.props.gameLaunch(),this.loaded=!0,setTimeout(this.tryCaptureScreenForBackground.bind(this),2e3),b.off('loadcommit',c)};b.on('loadcommit',c),b.src=`about:blank`}initEvent(a){a.onRequestBeforeSendHeaders=(a)=>{let b=this.props.project;if(b){let d=a.url;if('main_frame'===a.type&&d.match(/\?load$/))return this.restart(),{cancel:!0};if('main_frame'===a.type&&0!==d.indexOf(`http://127.0.0.1:${global.proxyPort}`))return{cancel:!0};if(0!==d.indexOf(`http://127.0.0.1:${global.proxyPort}`)&&'none'==this.props.networkType)return r.display({command:s.DISPLAY_ERROR,data:{title:t.config.NO_NETWORK_TIPS_TITLE,error:{message:t.config.NO_NETWORK_TIPS_CONTENT.format(d)}}}),{cancel:!0};let e=a.requestHeaders||[],f=e.findIndex((a)=>{return'cookie'===a.name.toLowerCase()});e.splice(f,1);for(var c=0;c<e.length;++c)if('_Cookie'===e[c].name&&(e[c].name='Cookie'),'Referer'===e[c].name){let a=b.appid;b.platform&&b.ext_appid&&(a=b.ext_appid),e[c].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}return{requestHeaders:a.requestHeaders}}},a.onRequestHeadersReceived=(a)=>{let{type:b}=a;if('xmlhttprequest'===b){let b=a.responseHeaders||[],c={};return b.forEach((a)=>{let{name:b,value:d}=a;c[b]||(c[b]=[]),c[b].push(d)}),b.push({name:'for-weapp-devtools',value:JSON.stringify(c)}),{responseHeaders:b}}return{}},a.on('dialog',(a)=>{let b=a.messageType||'',c=a.messageText,d=a.dialog;if('alert'===b){if('DOCUMENT_READY'===c)this.onDocumentReady();else if(0===c.indexOf('SET_SOCKET_HEADER:'))try{let a=JSON.parse(c.replace('SET_SOCKET_HEADER:',''));w=a}catch(a){}else if('NEED_ENTER_FOREGROUND'===c){let a=g.SCENE_DEFAULT,b={};try{let c=this.props.project.condiction.game,d=c.list,e=c.current;a=d&&d[e]?d[e].scene:a,b=d&&d[e]?d[e].query:b,b=q.parse(b)}catch(a){}p('',{scene:a,query:b})}}else if('confirm'===b)a.preventDefault();else if('prompt'===b&&(a.preventDefault(),/^____sdk____/.test(c))){let b=JSON.parse(c.replace(/^____sdk____/,'')),d=b.command;'APPSERVICE_INVOKE'===d&&(this.syncDialogMap[b.data.callbackID]=a.dialog,this.props.assdkActions.exec(b.data))}})}reStart(){this.loaded&&this.initWebview()}onDocumentReady(){this.loaded=!0,this.props.setAppLaunched(!0),this.setWebviewOffset()}render(){let a=this.props,c={height:a.height,width:a.width,position:'absolute'};return b.createElement('div',{className:'webview',ref:(a)=>this.container=a,style:c})}}module.exports=x((a)=>{let b=a.toolbar.deviceInfo,c=a.project.current,d=a.simulator.appConfig||{},e=a.simulator.orientation&&'landscape'==a.simulator.orientation.value,f=e?b.screenWidth:b.screenHeight;return{ua:b.ua||'',width:e?b.screenHeight:b.screenWidth,height:f,dpr:b.dpr,id:2e4,project:a.project.current,ready:a.simulator.game&&a.simulator.game.ready,appConfig:a.simulator.appConfig,device:b,appLaunched:a.simulator.appLaunched,compileCommand:a.simulator.compileCommand,libVersion:c.libVersion,assdkCallbackInfo:a.simulator.assdkCallbackInfo,decryptedInfo:a.simulator.decryptedInfo,deviceScale:a.toolbar.deviceScale,captureScreen:a.simulator.captureScreen,networkType:a.toolbar.network.list[a.toolbar.network.current]||'wifi'}},(a)=>{return{simulatorActions:c.bindActionCreators(e,a),projectActions:c.bindActionCreators(f,a),assdkActions:c.bindActionCreators(h,a),setGame:c.bindActionCreators(e.setGame,a),setAppLaunched:c.bindActionCreators(e.setAppLaunched,a),gameLaunch:c.bindActionCreators(e.gameLaunch,a)}})(y)}(require('lazyload'),require);