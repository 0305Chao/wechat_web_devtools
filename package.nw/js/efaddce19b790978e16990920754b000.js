'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('glob'),c=require('path'),d=require('url'),e=require('react'),f=require('redux'),{connect:g}=require('react-redux'),h=require('lodash'),i=require('trash'),j=require('rmdir'),k=require('image-size'),l=require('mkdir-p'),m=require('./ff946754202ecf377034d29daac7c8d9.js'),n=require('./83822ab95828f61bf6a61c04d53246a8.js'),o=require('./72653d4b93cdd7443296229431a7aa9a.js'),p=require('./d62fc37d7aa6416d5dcc240ba94175cd.js'),q=require('./46f5e82e7b3fd4ec2c8023c3dcf88cc3.js'),r=require('./8c8af9e360a75571110bae2bcbfbba78.js'),s=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),t=require('./a8c87029da0fa06e986298d447ab0fe2.js'),u=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),v=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),w=require('./c1e9d0afe2f9700ca354dbeced1f34d5.js'),x=require('./da7c31daaf542cf1796023d8e344b98a.js'),y=require('./4e88c741ca9fb65fab96c500b6d7f2fb.js'),z=require('./41168dca39589e852da6631126d0f94d.js'),A=require('./514f85d2b0873069acdeb636da5dc337.js'),B=require('./a78e6d6a87de1708226375ca4c320d76.js'),C=require('./84b183688a46c9e2626d3e6f83365e13.js'),{whiteFileExtName:D}=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),E=require('./f15811258ec83bc7d2978d66ddd5ed8a.js'),F=require('./common/locales/index.js'),G=require('./3892cb9d0783075a973c350c41401370.js'),{validType:H,tokenManager:I}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),J={page:{".js":r.pageJS,".json":r.pageJSON,".wxml":r.pageWXML,".wxss":r.pageWXSS},component:{".js":r.componentJS,".json":r.componentJSON,".wxml":r.componentWXML,".wxss":r.componentWXSS}};const K={".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0};class L extends e.Component{constructor(a){super(a),this._typeCfg={miniprogram:{config:'app.json',lastConfigCache:{},getPath:this.getClientPath.bind(this)},plugin:{config:'plugin.json',lastConfigCache:{},getPath:this.getPluginPath.bind(this)}}}componentDidMount(){console.log('editor container mount',new Date),this.init()}componentWillUnmount(){this.cleanup()}componentWillReceiveProps(a){a.editorOpenFileInfo!=this.props.editorOpenFileInfo&&setTimeout(()=>{this.openFile()})}componentDidUpdate(a){a.project!==this.props.project&&a.project&&this.props.project&&(a.project.projectid===this.props.project.projectid?n.remoteEmit('REMOTE_PROJECT_UPDATED',this.props.project):(this.cleanup(),this.init())),a.focus!==this.props.focus&&(a.focus!==v.WINDOW_FOCUS.EDITOR&&this.props.focus===v.WINDOW_FOCUS.EDITOR?n.remoteEmit('REMOTE_FOCUS'):a.focus===v.WINDOW_FOCUS.EDITOR&&this.props.focus!==v.WINDOW_FOCUS.EDITOR&&n.remoteEmit('REMOTE_BLUR')),a.settings.edit.gitIgnoreWindowsReturn!==this.props.settings.edit.gitIgnoreWindowsReturn&&this.notifyGitStatus(),this.props.project.timeRecords&&this.props.project.timeRecords.pluginDocLastUploadTime&&(a.project.timeRecords?a.project.timeRecords.pluginDocLastUploadTime!==this.props.project.timeRecords.pluginDocLastUploadTime&&n.remoteEmit('REMOTE_PROJECT_UPDATED',{timeRecords:this.props.project.timeRecords}):n.remoteEmit('REMOTE_PROJECT_UPDATED',{timeRecords:this.props.project.timeRecords}))}openFile(){n.remoteEmit('OPEN_FILE',this.props.editorOpenFileInfo),n.remoteEmit('REMOTE_FOCUS')}init(){this.setupMessageCenter(),this.setupFileUtils(),this.initEditorExtension(),this.mtimes=new Map,this.files=new Map;const a=(a)=>m.sendMessage('EDITOR',JSON.stringify({type:'COMMAND',command:'setLocale',data:{locale:a}}));a(F.getLocale()),this._cancalLocaleListener=F.onChangeLocale(a)}cleanup(){try{this.cleanupMessageCenter(),this.cleanupFileUtils(),this._cancalLocaleListener()}catch(a){}}get container(){return this._container}set container(a){this._container=a}get editorWebview(){return this._editorWebview}set editorWebview(a){this._editorWebview=a}async setupFileUtils(){await this.getFileUtils(),this._onFileChange=this.onFileChange.bind(this),this.fileUtils.on('all',this._onFileChange)}async getFileUtils(){return this.fileUtils||(this.fileUtils=await p(this.props.project.projectpath)),this.fileUtils}getClientPath(){try{const a=C.normalizePath(this.props.project.miniprogramRoot);return'.'==a||'./'==a||a.startsWith('../')?'':a.endsWith('/')?a.slice(0,-1):a}catch(a){}return''}getPluginPath(){try{const a=C.normalizePath(this.props.project.pluginRoot);return'.'==a||'./'==a||a.startsWith('../')?'':a.endsWith('/')?a.slice(0,-1):a}catch(a){}return''}cleanupFileUtils(){this.fileUtils.removeListener('all',this._onFileChange)}setupMessageCenter(){window.ms=m,this._onEditorMessage=this.onEditorMessage.bind(this),m.on('EDITOR',this._onEditorMessage)}cleanupMessageCenter(){m.off('EDITOR',this._onEditorMessage)}initEditorExtension(){this.loadEditorWebview()}loadEditorWebview(){return this.editorWebview?void this.editorWebview.reload():void this.setupWebview()}setupWebview(){this.editorWebview&&(E.disable(this.editorWebview._webview),this.editorWebview.detach());const a=B.get('devtools',{}),b=B.get('editor',{});b.setAttribute('tabIndex','-1'),b._webview.style.width='100%',b._webview.style.height='100%';const c=I.getSessionToken(H.UA_TOKEN);b.setUserAgentOverride(`${b.originUserAgent} devtoolsedit port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c}`),b.on('dialog',(a)=>{const b=a.messageType||'',c=a.messageText,d=a.dialog;if('alert'===b);else if('confirm'===b){a.preventDefault();try{const a=JSON.parse(c);this.props.confirm(a,(a)=>{a?d.ok():d.cancel()})}catch(a){d&&d.cancel()}}else'prompt'===b&&c===v.GET_MESSAGE_TOKEN&&d.ok(m.getToken())}),b.on('newwindow',(a)=>{nw.Shell.openExternal(a.targetUrl)}),b.on('exit',(a)=>{('abnormal'===a.reason||'crashed'===a.reason||'killed'===a.reason)&&setTimeout(()=>{this.setupWebview()})});const e=/^\/__plugindoc__\/(.+)$/;b.onBeforeRequest=(a)=>{const b=d.parse(a.url).pathname,c=b.match(e);return c&&c[1]?{redirectUrl:`http://127.0.0.1:${global.proxyPort}/editor/files/doc/${c[1]}`}:/^file:\/\//i.test(a.url)?{cancel:!0}:void 0},b.src='html/editor.html',b.attach(this.container),this.editorWebview=b,E.enable(b._webview)}async onEditorMessage(a){let b={};try{b=JSON.parse(a)}catch(b){return void o.error(`onEditorMessage parse ${a} error ${b}`)}switch(b.type){case'FOCUS':{this.onReqFocus(b);break}case'GET_GIT_STATUS':{this.onReqGetGitStatus(b);break}case'REVIEW_FILE':{this.onReqReviewFile(b);break}case'RELOAD':{this.setupWebview();break}case'CLICK':{this.onWebviewClick();break}case'SHOW_EDITOR_IF_NEEDED':{this.props.show||this.props.toggleEditorWindow();break}case'TREE_SHOW':{this.setFileTreeShow();break}case'TREE_HIDE':{this.setFileTreeHide();break}case'GET_FILE':{this.onReqGetFile(b);break}case'GET_COMMIT_FILE':{this.onReqGetCommitFile(b);break}case'SAVE_FILE':{this.onReqSaveFile(b);break}case'FORMAT_CODE':{this.onReqFormatCode(b);break}case'FIND_IN_FILES':{this.onReqFindInFiles(b);break}case'SYNC_FILES':{this.onReqSyncFiles(b);break}case'INIT_PROJECT':{this.onReqInitProject(b);break}case'GET_API':{this.onReqGetAPI(b);break}case'OPEN_IN_DISK':{this.onReqOpenInDisk(b);break}case'OPEN_IN_TERMINAL':{this.onReqOpenInTerminal(b);break}case'RENAME':{this.rename(b);break}case'ADD_FILE':this.addFile(b);case'ADD_DIR':{this.addDir(b);break}case'ADD_PAGE':{this.addPage(b);break}case'CHECK_PAGE_AND_COMPILE':{this.checkPageAndCompile();break}case'ADD_COMPONENT':{this.addComponent(b);break}case'DELETE_FILE':{this.deleteFile(b);break}case'DELETE_DIR':{this.deleteDir(b);break}case'BUILD':{this.onReqBuild(b);break}case'UPLOAD_README':{this.onReqUploadReadme(b);break}case'OPEN_EXTERNAL_URL':{this.onReqOpenExternalURL(b);break}}}async notifyGitStatus(){let a={enabled:!1,head:null};if(await this.isGitEnabled())try{const b=await z({taskName:'getgithead',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a={enabled:!!b.enabled,head:b.enabled?b.head+'':null}}catch(b){console.warn('getgithead error',b),a={enabled:!1,head:null}}const b={type:'EMIT',eventType:'REMOTE_GIT_STATUS_CHANGE',payload:{gitEnabled:a}};m.sendMessage('EDITOR',JSON.stringify(b))}async isGitEnabled(){if(this._gitEnabled===void 0){let a=!1;try{const b=await z({taskName:'getgitenabled',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a=b.enabled}catch(b){console.warn('getgitenabled failed',b),a=!1}this._gitEnabled=a}return this._gitEnabled}unsetGitEnabled(){void 0===this._gitEnabled||(this._prevGitEnabled=this._gitEnabled,this._gitEnabled=void 0)}async onFileChange(a,b,d){const e=this.props.project,f=c.relative(e.projectpath,b);/^\.git(\\|\/)/i.test(f)&&this.unsetGitEnabled(),clearTimeout(this._updateGitStatusTimeout),this._updateGitStatusTimeout=setTimeout(async()=>{this._updateGitStatusTimeout=void 0;const a=await this.isGitEnabled();(a||!!this._prevGitEnabled!==!!a)&&(this._prevGitEnabled=a,this.notifyGitStatus())},600);const g=d?+d.mtime:0,h=d?this.getSerializableStat(d):{};let i={};if(b=this.getEditorPathFormat(f),('addDir'===a||'unlinkDir'===a)&&(b+='/'),this.triggerBuild(b,!1),'add'===a||'addDir'===a)this.files.set(b,!0),i={payload:{eventType:a,path:b,stat:h}};else if('unlink'===a||'unlinkDir'===a)this.files.delete(b),i={payload:{eventType:a,path:b,stat:h}};else if('change'===a){if(+this.files.get(b)==g)return;this.files.set(b,g),i={payload:{eventType:a,path:b,stat:h}}}else return void o.info(`edit.js watch ${a}`);i.eventType='REMOTE_EXTERNAL_FILE_CHANGE',i.type='EMIT',m.sendMessage('EDITOR',JSON.stringify(i))}triggerBuild(a,b=!0){const d=c.extname(a);if(D[d]){if('/project.config.json'!==a){a=this.normalizePath(a);const b=c.dirname(a),d=this.getClientPath(),e=this.getPluginPath();if(d&&0!==`${b}/`.indexOf(`${d}/`)&&e&&0!==`${b}/`.indexOf(`${e}/`))return}const{autoSave:d,autoRefresh:e}=this.props.settings.edit;b&&clearTimeout(this._rebuildCooldownTimeout),e&&(d?b&&(this._rebuildCooldownTimeout=setTimeout(()=>{this.props.rebuildImmediate(v.COMPILE_ORIGIN.SAVE_FILE)},v.REBUILD_INTERVAL.AUTO_REFRESH)):this._rebuildCooldownTimeout=setTimeout(()=>{this.props.rebuildImmediate(v.COMPILE_ORIGIN.SAVE_FILE)},v.REBUILD_INTERVAL.AUTO_REFRESH))}}async getFiles(){function b(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return new Promise(async(a)=>{const d=await this.getFileUtils(),e=d.getAllFileWithDir().map((a)=>'/'+a),f={},g=this.props.project.projectpath;for(const d of e)try{const a=await b(c.join(g,d));f[d]=_extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}catch(a){f[d]={}}a({files:e,info:f})})}getFiles2(c,{ignore:d=['.git','**/.git/**','node_modules','**/node_modules/**']}={}){function e(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return console.log('begin get file',new Date),new Promise((a,f)=>{b('**',{absolute:!0,ignore:d,cwd:c,nosort:!0,silent:!0,mark:!0,nodir:!1,dot:!0},async(b,d)=>{if(b)return void f(b);let g={};for(const a of d){const b=await e(a);g[a]=_extends({},b,{isDir:b.isDirectory(),isFile:!b.isDirectory()})}d=d.map((a)=>a.slice(c.length)),g=h.mapKeys(g,(a,b)=>b.slice(c.length)),console.log('end get file',new Date),a({files:d,info:g})})})}lstatRecursive(b,{absolute:d=!1,ignore:e=['.git']}={}){function f(b){return new Promise((c,d)=>{a.readdir(b,(a,b)=>{a?d(a):c(b)})})}function g(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return new Promise(async(a,i)=>{try{const e=await g(b);if(!e.isDirectory())return void i('project path is a file');const j=await f(b),k=j.map((a)=>c.join(b,a));let l=[],m={};for(;0<k.length;){let a=k.pop();const b=await g(a);if(b.isDirectory()){const b=await f(a);Array.prototype.push.apply(k,b.map((b)=>c.join(a,b))),a+='/'}l.push(a),m[a]=_extends({},b,{isDir:b.isDirectory(),isFile:!b.isDirectory()})}if(l=l.map((a)=>a.replace('\\','/')),m=h.mapKeys(m,(a,b)=>b.replace('\\','/')),!d){const a=b.length;l=l.map((b)=>b.slice(a)),m=h.mapKeys(m,(b,c)=>c.slice(a))}a({files:l,info:m})}catch(a){i(a)}})}onReqFocus(){if(this.editorWebview&&this.editorWebview._webview){const a=this.editorWebview._webview;a.click&&a.click(),a.focus&&a.focus(),this.onWebviewClick()}}onWebviewClick(){if(this.editorWebview&&this.editorWebview._webview){const a=new UIEvent('click',{bubbles:!0});this.editorWebview._webview.dispatchEvent(a)}}setFileTreeShow(){this.props.setFileTreeShow(!0)}setFileTreeHide(){this.props.setFileTreeShow(!1)}checkPageAndCompile(b){for(const d in this._typeCfg){const b=this._typeCfg[d],e=c.join(this.props.project.projectpath,b.getPath(),b.config);try{const b=a.readFileSync(e);this.autoAddAllPage(d,b)}catch(a){}}this.onReqBuild(b)}autoAddPageOnInitiativeSave(a){try{const b=this.normalizePath(a.path),d=c.join(this.props.project.projectpath,b);for(const b in this._typeCfg){const e=this._typeCfg[b];d===c.join(this.props.project.projectpath,e.getPath(),e.config)&&this.autoAddAllPage(b,a.data)}}catch(a){}}onReqSaveFile(b){let d;try{b.initiative&&this.autoAddPageOnInitiativeSave(b);const e=this.normalizePath(b.path),f=c.join(this.props.project.projectpath,e);this.fileUtils.writeFileSync(e,b.data,'utf8');const g=a.lstatSync(f);d={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(g)}},this.mtimes.set(f,+g.mtime),this.files.set(b.path,g.mtime)}catch(a){o.error(`editor.container.js: onReqSaveFile error: ${a}`),d={errMsg:a.toString(),type:'CALLBACK',callback:b.callback}}m.sendMessage('EDITOR',JSON.stringify(d)),x('weapp_editor_savefile',this.props.project.appid),this.props.settings.edit.autoSave&&this.props.settings.edit.autoRefresh&&b.initiative&&this.triggerBuild(b.path,b.initiative)}async onReqGetGitStatus(a){console.log('editor.container.js, onReqGetGitStatus',a);const b={type:'CALLBACK',callback:a.callback,payload:{}};if(await this.isGitEnabled()){let a={};try{const b=await z({taskName:'getgitstatus',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a=b.status||{}}catch(b){console.warn('getGitStatus failed',b),a={}}const c={},d={};for(const b in a){if(!a.hasOwnProperty(b))continue;const e=a[b];d[this.getEditorPathFormat(b)]=c[e]=c[e]||{ignored:A.isStatusIgnored(e),new:A.isStatusNew(e),modified:A.isStatusModified(e),deleted:A.isStatusDeleted(e),staged:A.isStatusStaged(e),conflict:A.isStatusConflict(e)}}b.payload=d}m.sendMessage('EDITOR',JSON.stringify(b))}async onReqReviewFile(a){const b={type:'CALLBACK',callback:a.callback,payload:{gitLineDiffs:[]}},c=this.props.project.projectpath;if(await this.isGitEnabled()){const c=this.normalizePath(a.path);let d=[];try{let b=a.data||'';this.props.settings.edit.gitIgnoreWindowsReturn&&(b=b.replace(/\r\n/g,'\n'));const e=await z({taskName:'getgitlinediffs',config:{dir:this.props.project.projectpath,path:c},dataStr:b,maxTimeout:60000,useBackup:!1,downgrade:!0});if(e.error)throw e.error;d=e.gitLineDiffs||[]}catch(a){d=[]}b.payload.gitLineDiffs=d}m.sendMessage('EDITOR',JSON.stringify(b))}async onReqFormatCode(a){let b;try{b=this.props.settings.edit.tabSize}catch(a){b=2}const c=w(a.data,b),d={type:'CALLBACK',callback:a.callback,payload:c};m.sendMessage('EDITOR',JSON.stringify(d))}async onReqInitProject(a){const{files:b,info:c}=await this.getFiles(),d={},e=this.props.settings;for(const b in e.appearance)d[b]=e.appearance[b];for(const b in e.edit)d[b]=e.edit[b];const f={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{project:_extends({},this.props.project,{name:this.props.project.projectname,path:this.props.project.projectpath,createTime:this.props.project.createTime}),files:b,info:c,config:d}};b.forEach((a)=>{this.files.set(a,!0)}),m.sendMessage('EDITOR',JSON.stringify(f)),this.notifyGitStatus()}async onReqGetAPI(a){let b;try{b=!!this.props.project.attr.gameApp}catch(a){b=!1}const c=await y.getFallbackAPI(b),d={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{files:c}};m.sendMessage('EDITOR',JSON.stringify(d))}async onReqSyncFiles(a){const{files:b,info:c}=await this.getFiles(),d={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{files:b,info:c}};b.forEach((a)=>{this.files.set(a,!0)}),m.sendMessage('EDITOR',JSON.stringify(d))}async onReqGetCommitFile(a){const b={type:'CALLBACK',callback:a.callback,payload:{content:null,stats:null}};if(await this.isGitEnabled()){let c,d;const e=this.normalizePath(a.path);try{const a=await z({taskName:'getgitcommitfile',config:{dir:this.props.project.projectpath,path:e},maxTimeout:60000,useBackup:!1,downgrade:!0});if(a.error)throw a.error;c=a.content||null,d=a.stats||null}catch(a){console.warn('getGitCommitFile failed',a),c=null,d=null}b.payload.content='string'==typeof c?c:null,b.payload.stats=d||null}m.sendMessage('EDITOR',JSON.stringify(b))}async onReqGetFile(b){if(K[c.extname(b.path).toLowerCase()]){let e=d.resolve(`http://127.0.0.1:${global.proxyPort}/editor/files/`,this.normalizePath(b.path));try{e=decodeURI(e)}catch(a){}const f=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(f))return;if(!this.isSecurePath(f))return;let g;try{g=k(f)}catch(a){g={width:-1,height:-1}}const h=a.statSync(f),i={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{url:e,dimension:g,stat:this.getSerializableStat(h)}};m.sendMessage('EDITOR',JSON.stringify(i))}else{const d=this.fileUtils.getFile(this.normalizePath(b.path)),e=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(e))return;const f=a.statSync(e),g={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{data:d,stat:this.getSerializableStat(f)}};m.sendMessage('EDITOR',JSON.stringify(g))}}async onReqFindInFiles(a){const{options:b,string:d}=a;let{cwd:e,i:f,wholeword:g}=b;e=c.join(this.props.project.projectpath,e||'');this.isSecurePath(e)&&this.isSecurePath(e)&&q({str:d,cwd:e,i:f,wholeword:g,project:{projectpath:this.props.project.projectpath}},(b,c)=>{const d={type:'CALLBACK',callback:a.callback};b?d.errMsg=JSON.stringify(b):(d.errMsg='',d.payload=c),m.sendMessage('EDITOR',JSON.stringify(d))})}onReqOpenInTerminal(a){const{path:b}=a,d=c.join(this.props.project.projectpath,b);G(d),m.sendMessage('EDITOR',JSON.stringify({errMsg:'',payload:{},type:'CALLBACK',callback:a.callback}))}onReqOpenInDisk(a){const{path:b}=a,d=c.join(this.props.project.projectpath,b);this.isSecurePath(d)&&(nw.Shell.showItemInFolder(d),m.sendMessage('EDITOR',JSON.stringify({errMsg:'',payload:{},type:'CALLBACK',callback:a.callback})))}onReqUploadReadme(a){try{this.props.setUploadPluginDocInfo({show:!0}),m.sendMessage('EDITOR',JSON.stringify({type:'CALLBACK',callback:a.callback}))}catch(b){m.sendMessage('EDITOR',JSON.stringify({errMsg:b.toString(),type:'CALLBACK',callback:a.callback}))}}onReqOpenExternalURL(a){try{const{link:b}=a;b&&/^http(s):/.test(b)&&nw.Shell.openExternal(b),m.sendMessage('EDITOR',JSON.stringify({type:'CALLBACK',callback:a.callback}))}catch(b){m.sendMessage('EDITOR',JSON.stringify({errMsg:b.toString(),type:'CALLBACK',callback:a.callback}))}}rename(b){const{oldPath:d,newPath:e}=b;try{const f=c.join(this.props.project.projectpath,d),g=c.join(this.props.project.projectpath,e);if(!this.isSecurePath(f)||!this.isSecurePath(g))return;a.renameSync(f,g);const h=a.lstatSync(g);this.files.delete(this.getEditorPathFormat(d)),this.files.set(e,!0),m.sendMessage('EDITOR',JSON.stringify({type:'CALLBACK',errMsg:'',payload:{stat:this.getSerializableStat(h)},callback:b.callback}))}catch(a){m.sendMessage('EDITOR',JSON.stringify({errMsg:a.toString(),type:'CALLBACK',callback:b.callback}))}}addFile(b){try{const d=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(d))return;a.writeFileSync(d,'','utf8');const e=a.lstatSync(d);this.mtimes.set(d,+e.mtime);const f={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(e)}};this.files.set(b.path,!0),m.sendMessage('EDITOR',JSON.stringify(f))}catch(a){m.sendMessage('EDITOR',JSON.stringify({errMsg:a,type:'CALLBACK',callback:b.callback}))}}addDir(b){try{const d=c.join(this.props.project.projectpath,this.removeTrailingSlash(this.normalizePath(b.path)));if(!this.isSecurePath(d))return;l.sync(d);const e=a.lstatSync(d);this.mtimes.set(d,+e.mtime);const f={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(e)}};this.files.set(b.path,!0),m.sendMessage('EDITOR',JSON.stringify(f))}catch(a){m.sendMessage('EDITOR',JSON.stringify({errMsg:a.toString(),type:'CALLBACK',callback:b.callback}))}}autoAddAllPage(a,b){const c=this._typeCfg[a];let d,e,f;try{f=JSON.parse(b)}catch(a){return}'miniprogram'===a&&(d=c.lastConfigCache.pages||[],e=f.pages||[]),'plugin'===a&&(d=h.values(c.lastConfigCache.pages),e=h.values(f.pages));let g=h.difference(e,d);try{g.forEach((b)=>{this.autoAddPage(b,a)})}catch(a){}c.lastConfigCache=f}autoAddPage(a,b){try{const d=this._typeCfg[b].getPath(),e=this.normalizePath(a),f=c.join(this.props.project.projectpath,d,e),g=c.normalize(c.join(this.props.project.projectpath,d)),h=c.normalize(c.resolve(f,'..'));if(!h.startsWith(g)&&h!==g)return void console.warn('given page path out of range');this.addPageInDir(f,e)}catch(a){}}addPageInDir(b,d){try{const e=c.dirname(b);for(const c in l.sync(e),J.page)try{a.existsSync(`${b}${c}`)||a.writeFileSync(`${b}${c}`,J.page[c].replace(/\{\{page\}\}/g,d))}catch(a){}}catch(a){}}addPage(b){try{let d,e,f,g=this.removeTrailingSlash(this.normalizePath(b.path)),h=!1;for(const a in this._typeCfg)try{e=this._typeCfg[a],d=e.getPath();const b=new RegExp(`^${d}/`);let i=g.replace(b,'');if(f=JSON.parse(this.fileUtils.getFile(c.join(d,e.config))),'miniprogram'==a&&(!d||b.test(g))){const a=f.pages||[];a.includes(i)||a.push(i),f.pages=a,h=!0;break}if('plugin'==a&&b.test(g)){const a=f.pages||{},b=c.basename(i);b in a||(a[b]=i),f.pages=a,h=!0;break}}catch(a){}if(!h)return;let i;try{i=this.props.settings.edit.tabSize}catch(a){i=2}const j=c.join(this.props.project.projectpath,d,e.config);a.writeFileSync(j,JSON.stringify(f,null,i),'utf8');const k=c.join(this.props.project.projectpath,b.path);for(const b in J.page)try{a.existsSync(`${k}${b}`)||a.writeFileSync(`${k}${b}`,J.page[b].replace(/\{\{page\}\}/g,g))}catch(a){}const l=a.lstatSync(j),n={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(l)}};m.sendMessage('EDITOR',JSON.stringify(n))}catch(a){m.sendMessage('EDITOR',JSON.stringify({errMsg:a.toString(),type:'CALLBACK',callback:b.callback}))}}addComponent(b){try{const d=this.getClientPath(),e=new RegExp(`^${d}/`);let f=this.removeTrailingSlash(this.normalizePath(b.path));f=f.replace(e,'');const g=c.join(this.props.project.projectpath,b.path);if(!this.isSecurePath(g))return;for(const b in J.component)try{a.existsSync(`${g}${b}`)||a.writeFileSync(`${g}${b}`,J.component[b].replace(/\{\{component\}\}/g,f))}catch(a){}const h={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{}};m.sendMessage('EDITOR',JSON.stringify(h))}catch(a){m.sendMessage('EDITOR',JSON.stringify({errMsg:a.toString(),type:'CALLBACK',callback:b.callback}))}}async deleteFile(a){try{const b=c.join(this.props.project.projectpath,a.path);if(!this.isSecurePath(b))return;await i(b),this.files.delete(a.path),m.sendMessage('EDITOR',JSON.stringify({errMsg:'',type:'CALLBACK',callback:a.callback,payload:{}}))}catch(b){m.sendMessage('EDITOR',JSON.stringify({errMsg:b,type:'CALLBACK',callback:a.callback}))}}async deleteDir(a){try{const b=c.join(this.props.project.projectpath,a.path);if(!this.isSecurePath(b))return;await i(b),this.files.forEach((b,c)=>{c.startsWith(this.getEditorPathFormat(a.path,!0))&&this.files.delete(c)}),m.sendMessage('EDITOR',JSON.stringify({errMsg:'',type:'CALLBACK',callback:a.callback,payload:{}}))}catch(b){m.sendMessage('EDITOR',JSON.stringify({errMsg:b.toString(),type:'CALLBACK',callback:a.callback,payload:{}}))}}async onReqBuild(a){clearTimeout(this._rebuildCooldownTimeout),this._rebuildCooldownTimeout=setTimeout(()=>{this.props.rebuildImmediate(a&&a.data)},v.REBUILD_INTERVAL.AUTO_REFRESH)}getSerializableStat(a){return _extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}normalizePath(a){return a=a.replace(/\\/g,'/'),'/'===a[0]?a.substr(1):a}getEditorPathFormat(a,b=!1){return a=a.replace(/\\/g,'/'),b&&!a.endsWith('/')&&(a+='/'),'/'===a[0]?a:'/'+a}removeTrailingSlash(a){return a.endsWith('/')?a.slice(0,-1):a}isSecurePath(a){return a.startsWith(this.props.project.projectpath)}render(){const a=this.props;if(!a.project)return null;let b='monaco';return a.show||(b+=' ui-invisible'),e.createElement('div',{className:b,style:{minHeight:'97px'},tabIndex:-1,ref:(a)=>this.container=a})}}module.exports=g((a)=>({editorOpenFileInfo:a.info.editorOpenFileInfo,show:a.window.editor&&a.window.editor.show,project:a.project.current,settings:a.settings,focus:a.window.focus}),(a)=>({confirm(b,c){a(s.setConfirmInfo(_extends({show:!0,showCancel:!0,callback:c,confirmText:F.config.CONFIRM,cancelText:F.config.CANCEL},b)))},setFileTreeShow(b){a(t.setEditor({fileTreeShow:b}))},toggleEditorWindow(){a(t.toggleEditorWindow())},rebuildImmediate(b){a(u.compileImmediate({origin:b}))},setUploadPluginDocInfo(b){a(s.setUploadPluginDocInfo(b))}}))(L)}(require('lazyload'),require);