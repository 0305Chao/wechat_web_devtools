"use strict";!function(require,directRequire){"use strict";var a=this&&this.__decorate||function(a,b,e,f){var g,d=arguments.length,c=3>d?b:null===f?f=Object.getOwnPropertyDescriptor(b,e):f;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(a,b,e,f);else for(var h=a.length-1;0<=h;h--)(g=a[h])&&(c=(3>d?g(c):3<d?g(b,e,c):g(b,e))||c);return 3<d&&c&&Object.defineProperty(b,e,c),c};Object.defineProperty(exports,"__esModule",{value:!0});const b=require('./02a96d04e49a39ea9d70e3d9d372379a.js'),c=require("eventemitter3"),d=require('./a148d3a11fd5268109e21fb40c9d527b.js'),e=require('./46d7303eb986fa402d60bf5e929aa077.js'),f=require('./56a764ae9cb4336bf6babe1c1da0275b.js'),g=require("path"),h=require("fs");let i=null;try{const a=require(e.isMac?"node-sync-ipc":"node-sync-ipc-nwjs");i=a.parent()}catch(a){i=null}const j=require('./d35be2e4f5d3b317eb7ee15987e74d92.js'),k=require('./ebfcad0a5e72b6e693634486564b1394.js').devVendorList,{getAvailablePort:l}=require('./84b183688a46c9e2626d3e6f83365e13.js'),m=(()=>{let a=g.join(g.dirname(process.execPath),"node");return"darwin"!==process.platform&&(a+=".exe"),a})(),n=e.isDev?g.join(__dirname,"../../../libs/remote-helper.js"):g.join(__dirname,"./libs/remote-helper.js"),o=f.default("[remotedebug]"),p=f.default("[cp]"),q=e.logInvoke(o),r=e.logStack(o),s=Symbol("storageNotFound"),t=(()=>{let a;return async function(){return a?Promise.resolve(a):(a=await l(),Promise.resolve(a))}})();class u extends c.EventEmitter{constructor(a){super(),this.deviceInfo=void 0,this.clientNetworkType=void 0,this.clientNetworkSpeed=void 0,this.clientNetworkInterval=0,this.currentSyncSdkName=void 0,this.currentSyncSdkCallId=void 0,this.currentSyncSdkResolver=null,this.messager=null,this.cpReady=!1,this.destroyed=!1,this.usingLocalStorage=!1,this.debuggerStatus=0,this.debuggerStatusChangeTimeout=void 0,this.cpQueue=[],this.msQueue=[],this.cp=null,this.lastEvalTime=void 0,this.delayedQueue=[],this._askForRetryFn=()=>Promise.resolve(!1),this.autoPingTimeout=void 0,this.autoSaveStorageTimeout=void 0,this.lastPongResponse=void 0,this._storageCache=null,this._onRemoteDebugMessage=void 0,this.files=a.files,this.dir=a.dir,this.dataDir=a.dataDir,this.tempDir=a.tempDir,this.initialRoomInfo=Object.assign({},a.initialRoomInfo),this.usingLocalStorage=!!(a.config||{}).usingLocalStorage}onAskForRetry(a){this._askForRetryFn=a,this.messager&&this.messager.onAskForRetry(a)}changeDebuggerStatus(a){this.debuggerStatus=a,this.debuggerStatusChangeTimeout||(this.debuggerStatusChangeTimeout=setTimeout(()=>{this.debuggerStatusChangeTimeout=void 0,this.onDebuggerStatusChange()},500))}async init(){if(global.rd=this,!i)throw o.e("node-sync-ipc is broken"),new Error("node-sync-ipc is broken.");this.messager=new b.Messager({tempDir:this.tempDir,initialRoomInfo:this.initialRoomInfo}),this.messager.on("statuschange",this.onMessagerStatusChange.bind(this)),this.messager.on("debugmessage",this.onDebugMessage.bind(this)),this.messager.init(),this.messager.onAskForRetry(this._askForRetryFn),this.messager.on("accident",this.onMessagerAccident.bind(this)),this.messager.on("event",this.onMessagerEvent.bind(this));const a={httpPort:(global.proxyPort||9973)+"",initialInspectPort:(await t())+"",dir:this.dir,tempDir:this.tempDir,dataDir:this.dataDir,usingLocalStorage:this.usingLocalStorage?"yes":"no",isDev:e.isDev?"yes":"no",files:JSON.stringify(this.files),devVendorList:e.isDev?JSON.stringify(k):JSON.stringify([]),devVendorPath:e.isDev?g.join(__dirname,"../../../vendor/remotedev/"):""},c=this.cp=i.fork(n,[],{execPath:m,env:a,stdio:["ipc"]});c.stdout&&c.stdout.setEncoding("utf8"),c.stdout&&c.stdout.on("data",(a)=>{p.i(a.toString())}),c.stderr&&c.stderr.on("data",(a)=>{p.e(a.toString())}),c.on("message",this.onCpMessage.bind(this)),c.onSync("sdksyncapi",this.onCpSyncMessage.bind(this)),c.onSync("sdkstorageapi",this.onCpStorageMessage.bind(this));const d=this.destroy.bind(this);this.messager.on("destroy",this.onMessagerDestroy.bind(this)),c.on("disconnect",d),c.on("close",d),c.on("exit",(a)=>{o.w("cp exited with code "+a),d()}),c.on("error",(a)=>{o.e("cp encountered error",a.toString()),d()})}onDebuggerStatusChange(){const a={is_hit:this.debuggerStatus};this.sendMessageToClient(a,d.DebugMessageCategory.Breakpoint),this.emit("statuschange")}onMessagerStatusChange(a){if(a<=b.ConnectionStatus.Dead){this.currentSyncSdkResolver&&this.currentSyncSdkResolver("debug session end");this.sendMessageToCp({type:"debugEnable",data:{enabled:!1}})}else if(0<this.msQueue.length){const a=[...this.msQueue];this.msQueue=[];for(const b of a)this.sendMessageToClient(b.message,b.category,b.extra)}a>=b.ConnectionStatus.ServerBlocked&&!this.autoPingTimeout?this.enableAutoPing():a<b.ConnectionStatus.ServerBlocked&&this.autoPingTimeout&&(clearTimeout(this.autoPingTimeout),this.lastPongResponse=void 0),this.emit("statuschange")}onMessagerAccident(){this.emit("statuschange")}onMessagerEvent(a){this.emit("event",a)}onMessagerDestroy(){}onCpMessage(a){if("sendMessageToClient"===a.type)return void this.sendMessageToClient(a.data.debugObject,a.data.category,a.data.extra);if("vmReady"===a.type){const b=a.data.inspectUrl.replace(/^ws\:\/\//i,""),c=`chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws=${b}`;this.cpReady=!0;const d=[...this.cpQueue];for(const a of d)this.sendMessageToCp(a);setTimeout(()=>this.emit("initsuccess",{url:c}),0),j.register(this._onRemoteDebugMessage=this.onRemoteDebugMessage.bind(this))}else"error"===a.type&&o.e("cp send error message",a.data.error)}onRemoteDebugMessage(a){if(!a||!a.command)return void o.w("invalid remoteDebugMessager message");const{command:b,data:c}=a;return"STORAGE_PANNEL_SHOW"===b?(j.ready=!0,void this.notifyStorageUpdate()):"STORAGE_PANNEL_HIDE"===b?void(j.ready=!1):"EXEC_STORAGE_SDK"===b?void(c?this.sdkStorageOperate(c.api,c.args):o.e("invalid remoteDebugMessager storage operation")):void e.expectFail.fail(()=>{o.e("invalid remoteDebugMessager command",b)})}notifyStorageUpdate(){if(j&&j.ready){const a=this.storage,b=Object.keys(a),c={};for(const a of b)try{const b=this.sdkStorageOperate("getStorageSync",{key:a});b&&(delete b.errMsg,c[a]=b)}catch(b){o.e("error notify storage update",a)}j.send({command:"UPDATE_STORAGE",data:c})}}get storage(){if(!this._storageCache){const a=g.join(this.dataDir,"storage");try{const b=h.readFileSync(a,"utf-8");this._storageCache=JSON.parse(b)}catch(b){o.e("error loading storage cache from",a),this._storageCache={}}}return this._storageCache}autoSaveStorage(){this.autoSaveStorageTimeout||(this.autoSaveStorageTimeout=setTimeout(()=>{this.autoSaveStorageTimeout=void 0;const a=g.join(this.dataDir,"storage"),b=this.storage;try{const c=JSON.stringify(b);h.writeFileSync(a,c,"utf-8")}catch(b){o.e("saving storage file",a,"failed")}this.notifyStorageUpdate()},0))}storageOperate(a,b,c){const d=this.storage;if(!d)throw new Error("storage invalid");if("get"===a){if(!d.hasOwnProperty(b))return s;const a=d[b];return JSON.parse(a)}if("set"===a)d[b]=JSON.stringify(c),this.autoSaveStorage();else if("remove"===a)delete d[b],this.autoSaveStorage();else if("clear"===a){for(const a in d)delete d[a];this.autoSaveStorage()}else{const a={keys:Object.keys(d),limitSize:10240};let b=0;for(const a in d)b+=d[a].length;return b=Math.ceil(b/1024),a.currentSize=b,a}}sdkStorageOperate(a,b){let c;if("getStorage"===a||"getStorageSync"===a){const d=b.key;let e=this.storageOperate("get",d);if(e===s)c={errMsg:`${a}:fail data not found`};else{const b=Object.prototype.toString.call(e).slice(8,-1);"string"!==b.toLowerCase()&&(e=JSON.stringify(e)),c={errMsg:`${a}:ok`,data:e,dataType:b}}}else if("setStorage"===a||"setStorageSync"===a){const d=b,e=d.key;let f=d.data;const g=d.dataType;"string"!==g.toLowerCase()&&(f=JSON.parse(f)),this.storageOperate("set",e,f),c={errMsg:`${a}:ok`}}else if("removeStorage"===a||"removeStorageSync"===a){const d=b.key;this.storageOperate("remove",d),c={errMsg:`${a}:ok`}}else if("clearStorage"===a||"clearStorageSync"===a){this.storageOperate("clear"),c={errMsg:`${a}:ok`}}else c="getStorageInfo"===a||"getStorageInfoSync"===a?Object.assign({},this.storageOperate("info")||{},{errMsg:`${a}:ok`}):void 0;return c}onCpStorageMessage(a,b){if(e.expect(this.usingLocalStorage,o).toFuzzyEqual(!0).fail(()=>{o.e("operating local storage while using local storage is false")}),!b||!b.data||!b.data.debugObject){return void a({error:"debug message broken"})}const c=b.data.debugObject||{},d=c.args||[],f=d[0],g=d[1],h=parseInt(d[2],10),i=isNaN(h)?0:h;let j;try{if(j=this.sdkStorageOperate(f,JSON.parse(g)),!j)throw new Error("invalid sdk invoke")}catch(b){return void a({error:b+""})}const k={error:void 0,result:e.jsonStringify(j)};a(k)}onCpSyncMessage(a,b){if(!b||!b.data||!b.data.debugObject){return void a({error:"debug message broken"})}const c=b.data.debugObject,d=b.data.extra;d&&d.sdkName?this.currentSyncSdkName=d.sdkName:(o.w("invalid sync sdk name"),this.currentSyncSdkName="<unknown>"),this.currentSyncSdkCallId=c.call_id;const e=setTimeout(()=>{this.currentSyncSdkResolver&&this.currentSyncSdkResolver("timeout")},15000);this.currentSyncSdkResolver=(b,c)=>{clearTimeout(e),this.currentSyncSdkResolver=null,this.currentSyncSdkName=void 0,this.currentSyncSdkCallId=void 0;const d={error:b?b:void 0,result:c?c.ret:void 0};a(d),this.emit("statuschange")},this.onCpMessage(b),this.emit("statuschange")}sendMessageToClient(a,b,c){this.messager?this.messager.sendDebugMessage(a,b,c):(o.w("messager is not ready sending debug messages"),this.msQueue.push({message:a,category:b,extra:c}))}onDebugMessage(a){return a.category===d.DebugMessageCategory.Pong?(o.i("got pong response"),void this.handleDebugMessage(a)):void(this.delayedQueue.push(a),2>this.delayedQueue.length&&this.processDelayedQueue())}processDelayedQueue(){const a=Date.now();for(let b=!1;e.expect(Date.now(),o).as((b)=>10000>b-a).fail(()=>{o.e("loop processDelayedQueue running too long"),b=!0}).fail(()=>{this.emit("event",{type:"assertion",kind:"error",message:"processDelayedQueue loop too long"})}),!b;){const a=this.delayedQueue.shift();if(!a)break;const b=parseInt(a.delay+"",10),c=isNaN(b)?0:b;if(!this.lastEvalTime){this.lastEvalTime=Date.now(),this.handleDebugMessage(a);continue}this.lastEvalTime=Date.now(),this.handleDebugMessage(a)}}handleDebugMessage(a){const b=a.data||{};this.lastPongResponse=Date.now();const c=a.category;if(c===d.DebugMessageCategory.EvaluateJavascript)return void this.handleEvaluateJavascript(b);if(c===d.DebugMessageCategory.CallInterfaceResult)return void this.handleCallInterfaceResult(b);if(c===d.DebugMessageCategory.SetupContext)return void this.handleSetupContext(b);if(c===d.DebugMessageCategory.Pong){const{ping_id:a,network_type:c}=b;let d;return a&&(d=Date.now()-a,e.expect(d,o).as((a)=>0<=a).fail(()=>{o.e("something went wrong with ping id",a);this.emit("event",{kind:"warn",type:"assertion",message:"ping id is greater than current date"}),d=0-d})),void this.onClientNetworkChange(c,d)}o.e("received invalid debug category",c)}onClientNetworkChange(a,b){"number"==typeof a&&(this.clientNetworkType=a),"number"==typeof b&&(this.clientNetworkSpeed=300>b?d.ClientNetWorkSpeed.VeryGood:600>b?d.ClientNetWorkSpeed.Good:1e3>b?d.ClientNetWorkSpeed.Normal:5e3>b?d.ClientNetWorkSpeed.Bad:1e4>b?d.ClientNetWorkSpeed.VeryBad:d.ClientNetWorkSpeed.Lost,this.clientNetworkInterval=b),this.emit("statuschange")}enableAutoPing(){this.autoPingTimeout&&(o.w("already auto ping timeout"),clearTimeout(this.autoPingTimeout),this.lastPongResponse=void 0);const a=()=>{let b=!1;if("number"==typeof this.lastPongResponse&&10000<Date.now()-this.lastPongResponse&&(b=!0,this.onPingTimeout()),!b){const a={ping_id:Date.now()};this.sendMessageToClient(a,d.DebugMessageCategory.Ping)}this.autoPingTimeout=setTimeout(a,5000)};this.autoPingTimeout=setTimeout(a,0)}onPingTimeout(){this.onClientNetworkChange(d.ClientNetWorkType.Offline,Infinity)}handleSetupContext(a){const{device_info:b}=a;this.dtd=a,this.deviceInfo=b||{},this.emit("statuschange");this.sendMessageToCp({type:"handleSetupContext",data:a})}async handleCallInterfaceResult(a){const{call_id:b,ret:c}=a;if(this.currentSyncSdkCallId===b&&this.currentSyncSdkResolver)return this.currentSyncSdkResolver(void 0,a),void this.emit("statuschange");this.sendMessageToCp({data:a,type:"handleCallInterfaceResult"})}handleEvaluateJavascript(a){this.sendMessageToCp({data:a,type:"handleEvaluateJavascript"})}sendMessageToCp(a){this.cpReady&&this.cp?this.cp.send(a):(this.cpQueue.push(a),o.w("cp is not ready sending messages",a))}destroy(){if(this.destroyed)return void o.w("already destroyed");if(this.destroyed=!0,this.cpReady||(o.w("destroy before cp ready"),setTimeout(()=>this.emit("initfail"))),this.cp){const a=this.cp;setTimeout(()=>{e.tryCatch(()=>a.removeAllListeners()),e.tryCatch(()=>a.kill())},0)}if(this.cp=null,this.cpReady=!1,this.messager){const a=this.messager;setTimeout(()=>{a.removeAllListeners(),a.destroy()},0)}this.messager=null,this.autoPingTimeout&&clearTimeout(this.autoPingTimeout),this._onRemoteDebugMessage&&j.unRegister(this._onRemoteDebugMessage),this.emit("destroy")}}a([q],u.prototype,"changeDebuggerStatus",null),a([q],u.prototype,"onCpMessage",null),a([q],u.prototype,"onRemoteDebugMessage",null),a([q],u.prototype,"notifyStorageUpdate",null),a([q],u.prototype,"onCpStorageMessage",null),a([q],u.prototype,"onCpSyncMessage",null),a([q],u.prototype,"onClientNetworkChange",null),a([q],u.prototype,"onPingTimeout",null),a([q],u.prototype,"handleSetupContext",null),a([r],u.prototype,"destroy",null),exports.RemoteDebug=u}(require("lazyload"),require);