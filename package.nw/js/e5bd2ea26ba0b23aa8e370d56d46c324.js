'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('react'),d=require('redux'),e=require('./4b3c32249e0fb6e8d60bd516d6975f06.js'),f=require('./a78e6d6a87de1708226375ca4c320d76.js'),g=require('./2a5e5cdfba5a7802665ffdcfcb8c054d.js'),h=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),i=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),j=require('./d62fc37d7aa6416d5dcc240ba94175cd.js'),k=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),l=require('./da7c31daaf542cf1796023d8e344b98a.js'),{connect:m}=require('react-redux'),n=global.appConfig&&global.appConfig.isDev;class o extends c.Component{constructor(a){super(a),this.enabled=!1,this._onRequestEvent=this.onRequestEvent.bind(this),this._sdkReqs={}}componentDidMount(){this._onMessage=this.onMessage.bind(this),e.devtools.register((a)=>{n&&console.warn('[audits] devtools messager receive msg'),this._onMessage(a)}),e.appservice.register((a)=>{n&&console.warn('[audits] appservice messager receive msg'),this._onMessage(a)})}componentWillUnmount(){e.devtools.unRegister(this._onMessage),e.appservice.unRegister(this._onMessage)}componentWillReceiveProps(a){if(this.enabled&&a.debugInfo!=this.props.debugInfo&&a.debugInfo){const b=this.convertDebuggerProtocolReqEventToChromeWebReqEvent(a.debugInfo);b&&e.send({command:'ON_REQUEST_EVENT',data:b})}}getAppserviceInjection(){const c=global.appConfig.isDev?'./js/extensions/devtools/experience/appservice/index.js':b.join(__dirname,'./extensions/devtools/experience/appservice/index.js');return`${a.readFileSync(c,'utf8')}`}getWebviewInjection(){const c=global.appConfig.isDev?'./js/extensions/devtools/experience/webview/index.js':b.join(__dirname,'./extensions/devtools/experience/webview/index.js');return`${a.readFileSync(c,'utf8')}`}normalizePath(a){return a=a.replace(/\\/g,'/'),'/'===a[0]?a.substr(1):a}async getFileUtils(){return this.fileUtils||(this.fileUtils=await j(this.props.project.projectpath)),this.fileUtils}async getFiles(){function c(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return new Promise(async(a)=>{const d=await this.getFileUtils(),e=d.getAllFileWithDir().map((a)=>'/'+a),f={},g=this.props.project.projectpath;for(const d of e)try{const a=await c(b.join(g,d));f[d]=_extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}catch(a){f[d]={}}a({files:e,info:f})})}async onMessage(a){n&&console.log(a);try{a=JSON.parse(a)}catch(a){}const{command:b,data:c}=a;switch(b){case'TRANSFER':{e.appservice.send(a),e.devtools.send(a);break}case'FS_GET_FILES':{this.getFiles().then((a)=>{e.devtools.send({command:'RESP_FS_GET_FILES',data:{res:a}})}).catch((a)=>{e.devtools.send({command:'RESP_FS_GET_FILES',data:{err:a.toString()}})});break}case'FS_READ_FILE':{try{const a=await this.getFileUtils(),b=a.getFile(this.normalizePath(c.path));e.devtools.send({command:'RESP_FS_READ_FILE',data:{fileData:b,path:c.path}})}catch(a){e.devtools.send({command:'RESP_FS_READ_FILE',data:{err:a.toString()}})}break}case'FS_READ_TEMP_FILE':{try{const a=k.readFile(this.props.project,c.filePath,c.encoding);a.error?e.devtools.send({command:'RESP_FS_READ_TEMP_FILE',data:{err:a.reason}}):e.devtools.send({command:'RESP_FS_READ_TEMP_FILE',data:{filePath:c.filePath,encoding:c.encoding,fileData:a.fileData}})}catch(a){e.devtools.send({command:'RESP_FS_READ_TEMP_FILE',data:{err:a.toString()}})}break}case'START_EXPERIENCE_ANALYSIS':{this.enabled=!0,f.on('all',this._onRequestEvent),this.props.compile();break}case'STOP_EXPERIENCE_ANALYSIS':{this.enabled=!1,f.removeListener('all',this._onRequestEvent),g.remove('appservice'),g.remove('webview'),e.devtools.send(a);break}case'INJECT':{const a=this.getAppserviceInjection(),b=this.getWebviewInjection();f.webviews.simulator.forEach((a)=>{a._webview.executeScript({code:`var __exp_inject_script__ = document.createElement('script'); __exp_inject_script__.src = 'http://127.0.0.1:${global.proxyPort}/experience/webview/index.js'; document.body.appendChild(__exp_inject_script__)`})});const c=f.webviews.appservice;c&&c._webview.executeScript({code:`var __exp_inject_script__ = document.createElement('script'); __exp_inject_script__.src = 'http://127.0.0.1:${global.proxyPort}/experience/appservice/index.js'; document.body.appendChild(__exp_inject_script__)`}),g.add({id:'appservice',html:`<script>${a}</script>`,conditions:{type:'appservice',position:'onDocumentStart'}}),g.add({id:'webview',html:`<script>${b}</script>`,conditions:{type:'simulator',position:'onDocumentStart'}});break}case'REPORT':l('audits_info_report',this.props.project.appid,a.data);}}onRequestEvent(a){n&&console.warn(a),e.devtools.send({command:'ON_REQUEST_EVENT',data:a})}convertDebuggerProtocolReqEventToChromeWebReqEvent(a){function b(a,b){try{return a()}catch(a){return b}}try{switch(a.method){case'Network.requestWillBeSent':{const c={frameId:0,method:b(()=>a.params.request.method.toUpperCase(),'GET'),parentFrameId:-1,requestId:b(()=>a.params.requestId,-1),tabId:-1,timeStamp:b(()=>a.params.timestamp,+new Date),type:'xmlhttprequest',url:b(()=>a.params.request.url,'')},d={eventName:'onBeforeRequest',type:'appservice',deviceInfo:{id:'appservice'},details:c};return this._sdkReqs[c.requestId]={onBeforeRequest:d},d}case'Network.responseReceived':{const c=b(()=>a.params.requestId,-1);if(this._sdkReqs[c]&&this._sdkReqs[c].onResponseStarted)return;const d=this._sdkReqs[c].onBeforeRequest,e=b(()=>a.params.response.status,200),f=b(()=>a.params.response.statusText,'OK'),g=`HTTP/1.1 ${e} ${f}`,h={eventName:'onResponseStarted',type:'appservice',deviceInfo:{id:'appservice'},details:{frameId:0,fromCache:!1,method:d.details.method,parentFrameId:-1,requestId:c,statusCode:e,statusLine:g,timeStamp:b(()=>a.params.timestamp,+new Date),tabId:-1,type:'xmlhttprequest',url:d.details.url}};return this._sdkReqs[c].onResponseStarted=h,h}case'Network.dataReceived':return;case'Network.loadingFinished':{const c=b(()=>a.params.requestId,-1),d=this._sdkReqs[c].onResponseStarted,e={eventName:'onCompleted',type:'appservice',deviceInfo:{id:'appservice'},details:{frameId:0,fromCache:!1,method:d.details.method,parentFrameId:-1,requestId:c,statusCode:d.details.statusCode,statusLine:d.details.statusLine,tabId:-1,timeStamp:b(()=>a.params.timestamp,+new Date),type:'xmlhttprequest',url:d.details.url}};return delete this._sdkReqs[c],e}case'Network.loadingFailed':{const c=b(()=>a.params.requestId,-1),d=this._sdkReqs[c].onBeforeRequest,e={eventName:'onErrorOccurred',type:'appservice',deviceInfo:{id:'appservice'},details:{error:b(()=>a.params.errorText,'unknown error'),frameId:0,fromCache:!1,method:d.details.method,parentFrameId:-1,requestId:c,tabId:-1,timeStamp:b(()=>a.params.timestamp,+new Date),type:'xmlhttprequest',url:d.details.url}};return delete this._sdkReqs[c],e}}}catch(a){console.warn(a)}}render(){return null}}module.exports=m((a)=>({debugInfo:a.simulator.debugInfo,project:a.project.current}),(a)=>({compile:i.bindActionCreators(h.compile,a)}))(o)}(require('lazyload'),require);