'use strict';!function(require,directRequire){function a(a){let b=window.atob(a),c=b.length,d=new Uint8Array(c);for(let e=0;e<c;e++)d[e]=b.charCodeAt(e);return d.buffer}function b(a){let b=new Buffer(a.byteLength),c=new Uint8Array(a);for(let d=0;d<b.length;++d)b[d]=c[d];return b}const c=require('fs'),d=require('path'),e=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),f=require('./3bfffbe88b3d923921f851c0697974fe.js'),g=require('./c6f15ef7a40988103528a2ff766b2425.js'),h=require('crypto'),{enterBackground:i,enterForeground:j}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),k=require('mkdir-p'),l=require('rmdir'),m={".doc":!0,".xls":!0,".ppt":!0,".pdf":!0,".docx":!0,".xlsx":!0,".pptx":!0};module.exports={saveFile:async function(a,b){let e=b.args,h=e.tempFilePath,i=e.filePath;var j=g.getFileStat(h);if(!h||!j)return{errMsg:`${b.api}:fail file not found`};const k=f.getCurrentConfig(),l=k.setting.MaxFileStorageSize,m=f.getCurrent();let n=g.getSavedFileList();if(1024*(1024*l)<n.totalSize+j.size)return{errMsg:`${b.api}:fail exceeded the maximum size of the file storage limit ${l}M`};if(!i){let a=g.saveFileForever(h);return!1===a?{errMsg:`${b.api}:fail`}:{errMsg:`${b.api}:ok`,savedFilePath:a}}if(i){let a=g.getUsrFileRealPath(i),e=d.dirname(a);if(!a||!c.existsSync(e))return{errMsg:`${b.api}:fail no such file or directory ${i}`};let f=c.readFileSync(g.getRealPath(h));return c.writeFileSync(a,f),{errMsg:`${b.api}:ok`,savedFilePath:i}}},openDocument:async function(a,b){let e=b.args,{filePath:f,fileType:h}=e,k=!1;if(!h){let a=d.extname(f).toLowerCase();k=!m[a]}else k=!m[`.${h}`];if(k)return{errMsg:`${b.api}:fail filetype not supported`};let l=g.getRealPath(f);if(!c.existsSync(l))return{errMsg:`${b.api}:fail file not exist'`};if(i('openDocument'),h){let a=c.readFileSync(l);l=`${l}.${h}`,c.writeFileSync(l,a),nw.Shell.openItem(l)}else nw.Shell.openItem(l);return setTimeout(()=>j('openDocument'),200),{errMsg:`${b.api}:ok`}},getSavedFileList:async function(a,b){let c=g.getSavedFileList();return{errMsg:`${b.api}:ok`,fileList:c.fileList}},getSavedFileInfo:async function(a,b){let c=b.args,d=g.getFileStat(c.filePath);return d?{errMsg:`${b.api}:ok`,size:d.size,createTime:parseInt(d.ctime.getTime()/1e3)}:{errMsg:`${b.api}:fail file not found`}},getFileInfo:async function(a,b){let d=b.args,e=d.filePath,f=d.digestAlgorithm||'md5',i=g.getRealPath(e);if(!c.existsSync(i))return{errMsg:`${b.api}:fail file not found`};let j=g.getFileStat(e);if(j.isDirectory())return{errMsg:`${b.api}:fail filePath is directory`};let k=j.size,l='';if(f){let a=g.getRealPath(e),b=c.readFileSync(a);if('md5'==f){var m=h.createHash('md5');m.update(b),l=m.digest('hex')}else if('sha1'==f){var n=h.createHash('sha1');n.update(b),l=n.digest('hex')}}return{errMsg:`${b.api}:ok`,size:k,digest:l}},removeSavedFile:async function(a,b){let c=b.args,d=g.getFileStat(c.filePath);return d?(g.removeSavedFile(c.filePath),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail file not found`}},base64ToTempFilePath:async function(a,b){let c=b.args;if(c.base64Data){let a=g.saveBase64DataToFile(c.base64Data,'.png');if(a)return{errMsg:`${b.api}:ok`,tempFilePath:a}}return{errMsg:`${b.api}:fail`}},readFile:async function(a,b){let e=b.args,h=e.filePath;if(!h)return{errMsg:`${b.api}:fail file not found`};let i,j=e.length,k=e.position||0,l=e.encoding;if(g.isLocalId(h))i=g.getRealPath(h);else if(g.isUserFile(h))i=g.getUsrFileRealPath(h);else{let a=f.getCurrent(),b=a.client,c=d.extname(h),e={".wxml":!0,".js":!0,".wxss":!0};'mingganci'!==f.getCurrent().compileType&&(e['.json']=!0),e[c]||(b?i=d.join(a.projectpath,b,h):i=d.join(a.projectpath,h))}return c.existsSync(i)?new Promise((a)=>{let b=c.createReadStream(i,{start:k,end:Number.isInteger(j)?k+j:void 0}),e=[];b.on('data',function(a){e.push(a)}),b.on('end',function(){let b=Buffer.concat(e),c={errMsg:'readFile:ok'};l?c.data=b.toString():(c.base64=b.toString('base64'),c.__cover={base64:'data'}),a(c)})}):{errMsg:`${b.api}:fail file not found`}},writeFile:async function(d,e){let f=e.args,g=f.filePath,h=f.data||'',i=f.__dataisab;return i?(h=a(h),h=b(h)):h=Buffer.from(h),new Promise((a)=>{c.open(realPath,'w',(b,d)=>{return b?void a({errMsg:`${e.api}:fail ${b}`}):void c.write(d,h,0,h.length,0,(b)=>{c.close(d),b?a({errMsg:`${e.api}:fail ${b}`}):a({errMsg:`${e.api}:ok`})})})})},mkdir:async function(a,b){let e=b.args,f=e.dirPath,h=g.getUsrFileRealPath(f);if(c.existsSync(h))return{errMsg:`${b.api}:fail file already exists ${f}`};let i=d.dirname(h);if(!c.existsSync(i))return{errMsg:`${b.api}:fail no such file or directory ${f}`};try{return k.sync(h),{errMsg:`${b.api}:ok`}}catch(a){return{errMsg:`${b.api}:fail ${a}`}}},rmdir:async function(a,b){let d=b.args,e=d.dirPath,f=g.getUsrFileRealPath(e);if(!c.existsSync(f)||!c.lstatSync(f).isDirectory())return{errMsg:`${b.api}:fail no such file or directory ${e}`};let h=c.readdirSync(f).filter((a)=>{return 0!==a.indexOf('.')});return 0===h.length?new Promise((a)=>{l(f,(c)=>{c?a({errMsg:`${b.api}:fail ${c}`}):a({errMsg:`${b.api}:ok`})})}):{errMsg:`${b.api}:fail directory not empty`}},readdir:async function(a,b){let d=b.args,e=d.dirPath,f=g.getUsrFileRealPath(e);if(!c.existsSync(f))return{errMsg:`${b.api}:fail no such file or directory ${e}`};if(!c.lstatSync(f).isDirectory())return{errMsg:`${b.api}:fail not a directory ${e}`};try{let a=c.readdirSync(f).filter((a)=>{return 0!==a.indexOf('.')});return{errMsg:`${b.api}:ok`,files:a}}catch(a){return{errMsg:`${b.api}:fail ${a}`}}}}}(require('lazyload'),require);